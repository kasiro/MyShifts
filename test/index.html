<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>WorkShift Pro - Учет смен</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script>
        tailwind.config = {
            darkMode: 'class',
            theme: {
                extend: {
                    colors: {
                        dark: {
                            900: '#121212',
                            800: '#1E1E1E',
                            700: '#2D2D2D',
                            600: '#3A3A3A',
                            500: '#4A4A4A',
                        },
                        light: {
                            900: '#FFFFFF',
                            800: '#F8FAFC',
                            700: '#F1F5F9',
                            600: '#E2E8F0',
                            500: '#CBD5E1',
                        },
                        primary: {
                            DEFAULT: '#4F46E5',
                            600: '#4338CA',
                        }
                    }
                }
            }
        }
    </script>
</head>
<body class="dark:bg-dark-900 bg-light-900 dark:text-gray-200 text-gray-800">
    <div id="root" class="min-h-screen pb-16"></div>

    <script type="text/babel">
        const { useState, useEffect, useRef, useMemo } = React;
        const { createRoot } = ReactDOM;
        // Инициализация IndexedDB
        const initDB = () => {
            return new Promise((resolve, reject) => {
                const request = indexedDB.open('WorkShiftDB', 5);
                
                request.onupgradeneeded = (event) => {
                    const db = event.target.result;

                    if (!db.objectStoreNames.contains('shifts')) {
                        db.createObjectStore('shifts', { keyPath: 'id' });
                    }
                    if (!db.objectStoreNames.contains('settings')) {
                        db.createObjectStore('settings', { keyPath: 'id' });
                    }
                    if (!db.objectStoreNames.contains('areas')) {
                        db.createObjectStore('areas', { keyPath: 'id' });
                    }
                    if (!db.objectStoreNames.contains('materials')) {
                        db.createObjectStore('materials', { keyPath: 'id' });
                    }
                    if (!db.objectStoreNames.contains('material_prices')) {
                        const priceStore = db.createObjectStore('material_prices', {
                            keyPath: 'id'
                        });
                        priceStore.createIndex(
                            'area_material_idx',
                            ['areaId', 'materialId'],
                            { unique: true }
                        );
                    }
                };
                
                request.onsuccess = (event) => {
                    resolve(event.target.result);
                };
                
                request.onerror = (event) => {
                    reject('Error opening database');
                };
            });
        };

        const formatHoursToHMM = (hours) => {
            const totalMinutes = Math.round(hours * 60);
            const h = Math.floor(totalMinutes / 60);
            const m = totalMinutes % 60;
            const min_ = m.toString().padStart(2, '0');
            if (min_ == '00') {
                return `${h} ч`;
            }
            return `${h} ч, ${min_} м`;
        };

        // Сохранение данных в IndexedDB
        const saveData = async (storeName, data) => {
            const db = await initDB();
            return new Promise((resolve, reject) => {
                const transaction = db.transaction(storeName, 'readwrite');
                transaction.onerror = (event) => {
                    reject(`Transaction error: ${event.target.error}`);
                };
                const store = transaction.objectStore(storeName);
                const request = store.put(data);
                
                request.onsuccess = () => resolve();
                request.onerror = () => reject(`Error saving to ${storeName}`);
            });
        };
        
        const checkStoreExists = async (storeName) => {
            const db = await initDB();
            return db.objectStoreNames.contains(storeName);
        };

        // Функции для работы с ценами материалов
        // Сохранение цены материала
        const saveMaterialPrice = async (priceData) => {
            const db = await initDB();
            return new Promise((resolve, reject) => {
                const transaction = db.transaction('material_prices', 'readwrite');
                const store = transaction.objectStore('material_prices');
                
                // Проверяем, существует ли уже такая запись
                const index = store.index('area_material_idx');
                const checkRequest = index.get([priceData.areaId, priceData.materialId]);
                
                checkRequest.onsuccess = () => {
                    if (checkRequest.result) {
                        // Обновляем существующую запись
                        const existing = checkRequest.result;
                        const updated = {
                            ...existing,
                            pricePerUnit: priceData.pricePerUnit,
                            pricePerSheet: priceData.pricePerSheet
                        };
                        store.put(updated).onsuccess = resolve;
                    } else {
                        // Добавляем новую запись
                        store.add({
                            id: Date.now().toString(),
                            ...priceData
                        }).onsuccess = resolve;
                    }
                };
                
                transaction.onerror = () => reject(transaction.error);
            });
        };

        // Получение цен по участку
        const getMaterialPricesByArea = async (areaId) => {
            const db = await initDB();
            return new Promise((resolve) => {
                const transaction = db.transaction('material_prices', 'readonly');
                const store = transaction.objectStore('material_prices');
                const prices = [];
                
                // Используем курсор для перебора всех записей
                const request = store.openCursor();
                
                request.onsuccess = (e) => {
                    const cursor = e.target.result;
                    if (cursor) {
                        if (cursor.value.areaId === areaId) {
                            prices.push(cursor.value);
                        }
                        cursor.continue();
                    } else {
                        resolve(prices);
                    }
                };
                
                request.onerror = () => resolve([]);
            });
        };

        // Получение конкретной цены
        const getMaterialPrice = async (areaId, materialId) => {
            const db = await initDB();
            return new Promise((resolve) => {
                const transaction = db.transaction('material_prices', 'readonly');
                const store = transaction.objectStore('material_prices');
                const index = store.index('area_material_idx');
                
                index.get([areaId, materialId]).onsuccess = (e) => resolve(e.target.result);
            });
        };

        // Удаление цены
        const deleteMaterialPrice = async (id) => {
            const db = await initDB();
            return new Promise((resolve, reject) => {
                const transaction = db.transaction('material_prices', 'readwrite');
                const store = transaction.objectStore('material_prices');
                
                store.delete(id).onsuccess = () => resolve();
                transaction.onerror = () => reject(transaction.error);
            });
        };
            // Получение данных из IndexedDB
        const getData = async (storeName, id) => {
            const db = await initDB();
            return new Promise((resolve, reject) => {
                const transaction = db.transaction(storeName, 'readonly');
                const store = transaction.objectStore(storeName);
                const request = store.get(id);
                
                request.onsuccess = () => resolve(request.result);
                request.onerror = () => reject(`Error getting from ${storeName}`);
            });
        };

        // Получение всех данных из хранилища
        const getAllData = async (storeName) => {
            const db = await initDB();
            return new Promise((resolve, reject) => {
                const transaction = db.transaction(storeName, 'readonly');
                const store = transaction.objectStore(storeName);
                const request = store.getAll();
                
                request.onsuccess = () => resolve(request.result || []);
                request.onerror = () => reject(`Error getting all from ${storeName}`);
            });
        };

        // Удаление данных из IndexedDB
        const deleteData = async (storeName, id) => {
            const db = await initDB();
            return new Promise((resolve, reject) => {
                const transaction = db.transaction(storeName, 'readwrite');
                transaction.onerror = (event) => {
                    reject(`Transaction error: ${event.target.error}`);
                };
                const store = transaction.objectStore(storeName);
                const request = store.delete(id);
                
                request.onsuccess = () => resolve();
                request.onerror = () => reject(`Error deleting from ${storeName}`);
            });
        };

        // Основной компонент приложения
        function App() {
            const [shifts, setShifts] = useState([]);
            const [filteredShifts, setFilteredShifts] = useState([]);
            const [showShiftForm, setShowShiftForm] = useState(false);
            const [showAreaForm, setShowAreaForm] = useState(false);
            const [showAreaSettings, setShowAreaSettings] = useState(false);
            const [currentShiftId, setCurrentShiftId] = useState(null);
            const [currentAreaIndex, setCurrentAreaIndex] = useState(null);
            const [activeTab, setActiveTab] = useState('shifts');
            const [theme, setTheme] = useState('dark');
            const [savedAreas, setSavedAreas] = useState([]);
            const [filters, setFilters] = useState({
                sortOrder: 'desc', // 'asc' or 'desc'
                areaName: '',
                materialName: '',
                minQuantity: '',
                maxQuantity: '',
                minSheets: '',
                maxSheets: '',
                minPayment: '',
                maxPayment: '',
                startDate: '',
                endDate: ''
            });
            const [isFiltering, setIsFiltering] = useState(false);
            const [isFilteringNow, setIsFilteringNow] = useState(false);
            const filterTimeoutRef = useRef(null);
            const [savedMaterials, setSavedMaterials] = useState([]);
            const [showMaterialSettings, setShowMaterialSettings] = useState(false);

            // Добавление нового материала в настройки
            const addSavedMaterial = async (material) => {
                const materialWithId = {
                    ...material,
                    id: Date.now().toString()
                };
                
                try {
                    await saveData('materials', materialWithId);
                    setSavedMaterials(prev => [...prev, materialWithId]);
                } catch (error) {
                    console.error('Failed to save material:', error);
                }
            };

            // Удаление материала из настроек
            const deleteSavedMaterial = async (materialId) => {
                try {
                    await deleteData('materials', materialId);
                    setSavedMaterials(savedMaterials.filter(material => material.id !== materialId));
                } catch (error) {
                    console.error('Failed to delete material:', error);
                }
            };

            // Загрузка сохраненных материалов при монтировании
            useEffect(() => {
                const loadMaterials = async () => {
                    try {
                        const db = await initDB();
                        if (!db.objectStoreNames.contains('materials')) {
                            console.log('Materials store not found, skipping load');
                            setSavedMaterials([]);
                            return;
                        }

                        const materials = await getAllData('materials');
                        setSavedMaterials(materials || []);
                    } catch (error) {
                        console.error('Failed to load materials:', error);
                        setSavedMaterials([]);
                    }
                };
                loadMaterials();
            }, []);
            
            // Загрузка данных и настроек при монтировании
            useEffect(() => {
                const loadData = async () => {
                    try {
                        // Загрузка смен
                        const db = await initDB();
                        const shiftsTransaction = db.transaction('shifts', 'readonly');
                        const shiftsStore = shiftsTransaction.objectStore('shifts');
                        const shiftsRequest = shiftsStore.getAll();
                        
                        shiftsRequest.onsuccess = () => {
                            const loadedShifts = shiftsRequest.result || [];
                            setShifts(loadedShifts);
                            setFilteredShifts(loadedShifts);
                        };
                        
                        // Загрузка темы
                        const savedTheme = await getData('settings', 'theme');
                        if (savedTheme) {
                            setTheme(savedTheme.value);
                            document.documentElement.classList.add(savedTheme.value);
                        } else {
                            // Сохраняем тему по умолчанию
                            await saveData('settings', { id: 'theme', value: 'dark' });
                        }

                        // Загрузка сохраненных участков
                        const areas = await getAllData('areas');
                        setSavedAreas(areas);
                    } catch (error) {
                        console.error('Failed to load data:', error);
                    }
                };
                
                loadData();
            }, []);
            
            const isEqual = (obj1, obj2) => {
              const keys1 = Object.keys(obj1);
              const keys2 = Object.keys(obj2);

              if (keys1.length !== keys2.length) return false;

              return JSON.stringify(obj1) === JSON.stringify(obj2);
            }

            // Применение фильтров при их изменении
            useEffect(() => {
                if (shifts.length === 0) return;
                setIsFiltering(true);


                
                if (filterTimeoutRef.current) {
                    clearTimeout(filterTimeoutRef.current);
                }
                
                filterTimeoutRef.current = setTimeout(() => {
                    applyFilters();
                    setIsFiltering(false);

                    const def_filters_desc = getResetFilters('desc');
                    const def_filters_asc = getResetFilters('asc');
                    if (!isEqual(filters, def_filters_asc) && !isEqual(filters, def_filters_desc)) {
                        setIsFilteringNow(true);
                    } else {
                        setIsFilteringNow(false);
                    }
                }, 500); // 500 мс задержки
                
                return () => {
                    if (filterTimeoutRef.current) {
                        clearTimeout(filterTimeoutRef.current);
                    }
                };
            }, [filters, shifts]);

            // Функция применения фильтров
            const applyFilters = () => {
                let result = [...shifts];
                
                // Фильтрация по дате
                if (filters.startDate || filters.endDate) {
                    result = result.filter(shift => {
                        const shiftDate = new Date(shift.date);
                        const startDate = filters.startDate ? new Date(filters.startDate) : null;
                        const endDate = filters.endDate ? new Date(filters.endDate) : null;
                        
                        let valid = true;
                        if (startDate) valid = valid && shiftDate >= startDate;
                        if (endDate) valid = valid && shiftDate <= endDate;
                        return valid;
                    });
                }
                
                // Фильтрация по участку
                if (filters.areaName) {
                    result = result.filter(shift => {
                        return shift.areas?.some(area => {
                            return area.name.toLowerCase().includes(
                                filters.areaName.toLowerCase()
                            )
                        });
                    });
                }
                
                // Фильтрация по материалу
                if (filters.materialName) {
                    result = result.filter(shift => {
                        return shift.areas?.some(area => {
                            return area.materials?.some(material => {
                                return material.name.toLowerCase().includes(
                                    filters.materialName.toLowerCase()
                                );
                            });
                        });
                    });
                }
                
                // Фильтрация по количеству материала
                if (filters.minQuantity || filters.maxQuantity) {
                    result = result.filter(shift => {
                        return shift.areas?.some(area => {
                            return area.materials?.some(material => {
                                const quantity = parseInt(material.quantity) || 0;
                                let valid = true;
                                if (filters.minQuantity) valid = valid && quantity >= parseInt(filters.minQuantity);
                                if (filters.maxQuantity) valid = valid && quantity <= parseInt(filters.maxQuantity);
                                return valid;
                            })
                        })
                    })
                }
                
                // Фильтрация по количеству листов
                if (filters.minSheets || filters.maxSheets) {
                    result = result.filter(shift => {
                        return shift.areas?.some(area => {
                            return area.materials?.some(material => {
                                const sheets = Number(material.sheets) || 0;
                                if (sheets == 0) return false;
                                let valid = true;
                                if (filters.minSheets) valid = valid && sheets >= parseInt(filters.minSheets);
                                if (filters.maxSheets) valid = valid && sheets <= parseInt(filters.maxSheets);
                                return valid;
                            })
                        })
                    })
                }
                
                // Фильтрация по оплате
                if (filters.minPayment || filters.maxPayment) {
                    result = result.filter(shift => {
                        let totalPayment = shift.areas?.reduce((sum, area) => sum.payment + area.payment);
                        if (typeof totalPayment === 'object') {
                            totalPayment = totalPayment.payment;
                        }
                        let valid = true;
                        if (filters.minPayment != '') {
                            valid = valid && totalPayment >= Number(filters.minPayment);
                        }
                        if (filters.maxPayment != '') {
                            valid = valid && totalPayment <= Number(filters.maxPayment);
                        }
                        return valid;
                    });
                }
                
                // Сортировка
                result.sort((a, b) => {
                    const dateA = new Date(a.date);
                    const dateB = new Date(b.date);
                    return filters.sortOrder === 'asc' ? dateA - dateB : dateB - dateA;
                });
                
                setFilteredShifts(result);
            };
            
            const handleFilterChange = (name, value) => {
                setFilters(prev => ({
                    ...prev,
                    [name]: value
                }));
            };

            const getResetFilters = (order) => {
                return {
                    sortOrder: order,
                    areaName: '',
                    materialName: '',
                    minQuantity: '',
                    maxQuantity: '',
                    minSheets: '',
                    maxSheets: '',
                    minPayment: '',
                    maxPayment: '',
                    startDate: '',
                    endDate: ''
                };
            };

            const resetFilters = () => {
                setFilters({
                    sortOrder: 'desc',
                    areaName: '',
                    materialName: '',
                    minQuantity: '',
                    maxQuantity: '',
                    minSheets: '',
                    maxSheets: '',
                    minPayment: '',
                    maxPayment: '',
                    startDate: '',
                    endDate: ''
                });
            };
            
            // Сохранение смены
            const saveShift = async (shift) => {
                try {
                    await saveData('shifts', shift);
                    setShifts(shifts.map(s => s.id === shift.id ? shift : s));
                } catch (error) {
                    console.error('Failed to save shift:', error);
                }
            };

            
            
            // Добавление новой смены
            const addShift = async (newShift) => {
                const shiftWithId = {
                    ...newShift,
                    id: Date.now().toString(),
                    areas: []
                };
                
                try {
                    await saveData('shifts', shiftWithId);
                    setShifts([...shifts, shiftWithId]);
                    setShowShiftForm(false);
                } catch (error) {
                    console.error('Failed to save shift:', error);
                }
            };
            
            // Добавление участка к смене
            const addAreaToShift = async (shiftId, newArea) => {
                const updatedShifts = shifts.map(shift => {
                    if (shift.id === shiftId) {
                        const workHours = calculateWorkHours(
                            newArea.startTime, 
                            newArea.endTime, 
                            shift.lunchStart, 
                            shift.lunchEnd
                        );
                        return {
                            ...shift,
                            areas: [
                                ...(shift.areas || []), 
                                {
                                    ...newArea,
                                    workHours,
                                    payment: parseFloat(newArea.payment) || 0
                                }
                            ]
                        };
                    }
                    return shift;
                });
                
                try {
                    const updatedShift = updatedShifts.find(s => s.id === shiftId);
                    await saveShift(updatedShift);
                    setShifts(updatedShifts);
                    setShowAreaForm(false);
                } catch (error) {
                    console.error('Failed to update shift:', error);
                }
            };
            
            // Обновление участка в смене
            const updateAreaInShift = async (shiftId, areaIndex, updatedArea) => {
                const updatedShifts = shifts.map(shift => {
                    if (shift.id === shiftId) {
                        const workHours = calculateWorkHours(updatedArea.startTime, updatedArea.endTime);
                        const newAreas = [...shift.areas];
                        newAreas[areaIndex] = {
                            ...updatedArea,
                            workHours,
                            payment: parseFloat(updatedArea.payment) || 0
                        };
                        
                        return {
                            ...shift,
                            areas: newAreas
                        };
                    }
                    return shift;
                });
                
                try {
                    const updatedShift = updatedShifts.find(s => s.id === shiftId);
                    await saveShift(updatedShift);
                    setShifts(updatedShifts);
                    setShowAreaForm(false);
                } catch (error) {
                    console.error('Failed to update shift:', error);
                }
            };
            
            // Удаление смены
            const deleteShift = async (shiftId) => {
                try {
                    const db = await initDB();
                    const transaction = db.transaction('shifts', 'readwrite');
                    const store = transaction.objectStore('shifts');
                    const request = store.delete(shiftId);
                    
                    request.onsuccess = () => {
                        setShifts(shifts.filter(shift => shift.id !== shiftId));
                    };
                } catch (error) {
                    console.error('Failed to delete shift:', error);
                }
            };
            
            // Удаление участка
            const deleteArea = async (shiftId, areaIndex) => {
                const updatedShifts = shifts.map(shift => {
                    if (shift.id === shiftId) {
                        return {
                            ...shift,
                            areas: shift.areas.filter((_, index) => index !== areaIndex)
                        };
                    }
                    return shift;
                });
                
                try {
                    const updatedShift = updatedShifts.find(s => s.id === shiftId);
                    await saveShift(updatedShift);
                    setShifts(updatedShifts);
                } catch (error) {
                    console.error('Failed to update shift:', error);
                }
            };

            // Переключение темы
            const toggleTheme = async (newTheme) => {
                try {
                    await saveData('settings', { id: 'theme', value: newTheme });
                    setTheme(newTheme);
                    document.documentElement.classList.remove('dark', 'light');
                    document.documentElement.classList.add(newTheme);
                } catch (error) {
                    console.error('Failed to save theme:', error);
                }
            };

            // Добавление нового участка в настройки
            const addSavedArea = async (area) => {
                const areaWithId = {
                    ...area,
                    id: Date.now().toString()
                };
                
                try {
                    await saveData('areas', areaWithId);
                    setSavedAreas([...savedAreas, areaWithId]);
                } catch (error) {
                    console.error('Failed to save area:', error);
                }
            };

            // Удаление участка из настроек
            const deleteSavedArea = async (areaId) => {
                try {
                    await deleteData('areas', areaId);
                    setSavedAreas(savedAreas.filter(area => area.id !== areaId));
                } catch (error) {
                    console.error('Failed to delete area:', error);
                }
            };
            
            function SelectInput({
              value: controlledValue = '',
              onChange,
              List = [],
              onSelect = () => {},
              readonly_ = false,
              classes = '',
              placeholder_ = '',
              labelKey = 'name',
              valueKey = 'id',
              children
            }) {
              const [inputValue, setInputValue] = useState(controlledValue);
              const [showSuggestions, setShowSuggestions] = useState(false);
              const inputRef = useRef(null);

              // Получаем список вариантов один раз при монтировании
              const options = useMemo(() => {
                if (children) {
                  return React.Children.map(children, child => {
                    if (!React.isValidElement(child)) return null;
                    if (child.type === 'option') {
                      return {
                        id: child.props.value,
                        name: child.props.children,
                        value: child.props.value
                      };
                    }
                    return null;
                  }).filter(Boolean);
                }
                return List.map((item, index) => {
                  if (typeof item === 'string') {
                    return { id: index, name: item, value: item };
                  }
                  return {
                    id: item.id ?? item[valueKey] ?? index,
                    name: item[labelKey] ?? item.name ?? String(item),
                    value: item[valueKey] ?? item.id ?? item
                  };
                });
              }, [children, List, labelKey, valueKey]);

              // Фильтруем варианты на основе ввода
              const filteredOptions = useMemo(() => {
                if (!inputValue || readonly_) return options;
                return options.filter(item =>
                  String(item.name).toLowerCase().includes(inputValue.toLowerCase())
                );
              }, [inputValue, options]);

              // Синхронизация с внешним значением
              useEffect(() => {
                setInputValue(controlledValue);
              }, [controlledValue]);

              const handleChange = (e) => {
                if (onChange) {
                    const value = e.target.value;
                    setInputValue(value);
                    onChange(e);
                }
              };

              const handleSelect = (item) => {
                setInputValue(item.name);
                setShowSuggestions(false);
                onSelect(item.value);
              };

              // Закрытие при клике вне инпута
              useEffect(() => {
                const handleClickOutside = (e) => {
                  if (inputRef.current && !inputRef.current.contains(e.target)) {
                    setShowSuggestions(false);
                  }
                };

                document.addEventListener('mousedown', handleClickOutside);
                return () => document.removeEventListener('mousedown', handleClickOutside);
              }, []);

              return (
                <div className="relative" ref={inputRef}>
                  <input
                    type="text"
                    value={inputValue}
                    onChange={handleChange}
                    onFocus={() => setShowSuggestions(filteredOptions.length > 0)}
                    className={`${classes} w-full dark:bg-dark-600 bg-light-600 border dark:border-dark-500 border-light-400 rounded-lg px-3 py-2 text-sm focus:outline-none focus:ring-1 focus:ring-primary-600`}
                    placeholder={placeholder_ || 'Название...'}
                    readOnly={readonly_}
                  />

                  {showSuggestions && filteredOptions.length > 0 && (
                    <div className="block z-10 mt-1 w-full dark:bg-dark-600 bg-white border dark:border-dark-500 border-light-600 rounded-lg shadow-lg max-h-60 overflow-y-auto">
                      {filteredOptions.map((item) => (
                        <div
                          key={item.id}
                          className="px-3 py-2 hover:dark:bg-dark-500 hover:bg-light-500 cursor-pointer"
                          onClick={() => handleSelect(item)}
                        >
                          {item.name}
                        </div>
                      ))}
                    </div>
                  )}
                </div>
              );
            }

            return (
                <div className="max-w-6xl mx-auto px-4 py-8">
                    <Header />
                    
                    <div className="mt-6">
                        {activeTab === 'shifts' && (
                            <ShiftsTab 
                                shifts={filteredShifts} 
                                onAddShift={() => setShowShiftForm(true)}
                                onAddArea={(shiftId) => {
                                    setCurrentShiftId(shiftId);
                                    setCurrentAreaIndex(null);
                                    setShowAreaForm(true);
                                }}
                                onEditArea={(shiftId, areaIndex) => {
                                    setCurrentShiftId(shiftId);
                                    setCurrentAreaIndex(areaIndex);
                                    setShowAreaForm(true);
                                }}
                                onDeleteShift={deleteShift}
                                onDeleteArea={deleteArea}
                                theme={theme}
                                savedAreas={savedAreas}
                                filters={filters}
                                onFilterChange={handleFilterChange}
                                onResetFilters={resetFilters}
                                isFiltering={isFiltering}
                                isFilteringNow={isFilteringNow}
                                formatHoursToHMM={formatHoursToHMM}
                            />
                        )}
                        {activeTab === 'stats' && <StatsTab shifts={shifts} theme={theme} />}
                        {activeTab === 'settings' && (
                            <SettingsTab 
                                theme={theme} 
                                toggleTheme={toggleTheme} 
                                savedAreas={savedAreas}
                                onAddSavedArea={addSavedArea}
                                onDeleteSavedArea={deleteSavedArea}
                                showAreaSettings={showAreaSettings}
                                setShowAreaSettings={setShowAreaSettings}
                                showMaterialSettings={showMaterialSettings}
                                setShowMaterialSettings={setShowMaterialSettings}
                                savedMaterials={savedMaterials}
                                onAddSavedMaterial={addSavedMaterial}
                                onDeleteSavedMaterial={deleteSavedMaterial}
                                SelectInput={SelectInput}
                            />
                        )}
                    </div>
                    
                    <div className="fixed bottom-4 left-4 right-4 mx-auto max-w-md bg-light-800 rounded-2xl shadow-lg flex justify-around items-center p-2 h-16 z-10">
                        <TabButton 
                            active={activeTab === 'shifts'} 
                            onClick={() => setActiveTab('shifts')}
                            icon="list"
                            label="Смены"
                            theme={theme}
                        />
                        <TabButton 
                            active={activeTab === 'stats'} 
                            onClick={() => setActiveTab('stats')}
                            icon="chart-bar"
                            label="Статистика"
                            theme={theme}
                        />
                        <TabButton 
                            active={activeTab === 'settings'} 
                            onClick={() => setActiveTab('settings')}
                            icon="cog"
                            label="Настройки"
                            theme={theme}
                        />
                    </div>

                    {showShiftForm && (
                        <ShiftForm 
                            onAdd={addShift} 
                            onCancel={() => setShowShiftForm(false)} 
                            theme={theme}
                        />
                    )}
                    
                    {showShiftForm && (
                        <ShiftForm 
                            onAdd={addShift} 
                            onCancel={() => setShowShiftForm(false)} 
                            theme={theme}
                        />
                    )}
                    
                    {showAreaForm && (
                        <AreaForm 
                            shiftId={currentShiftId}
                            areaIndex={currentAreaIndex}
                            shift={shifts.find(s => s.id === currentShiftId)}
                            onAdd={addAreaToShift}
                            onUpdate={updateAreaInShift}
                            onCancel={() => setShowAreaForm(false)} 
                            theme={theme}
                            savedAreas={savedAreas}
                            savedMaterials={savedMaterials}
                            SelectInput={SelectInput}
                        />
                    )}
                </div>
            );
        }
        
        function Group({ name, onClick, icon, children }) {
            const [showGroup, setShowGroup] = useState(false);
            
            return (
                <div className="mt-4">
                    <button 
                        onClick={() => setShowGroup(!showGroup)}
                        className="w-full text-left p-3 hover:dark:bg-dark-700 hover:bg-light-700 rounded-lg flex justify-between items-center"
                    >
                        <span>
                            <i className={`fas fa-${icon} mr-2`}></i>
                            {name}
                        </span>
                        <i className={`fas fa-chevron-${showGroup ? 'up' : 'down'}`}></i>
                    </button>

                    {showGroup && children}
                </div>
            );
        }

        function MaterialPricesSettings({
            savedAreas,
            savedMaterials,
            theme,
            showMaterialPrices,
            setShowMaterialPrices,
            SelectInput
        }) {
            const [selectedArea, setSelectedArea] = useState('');
            const [materialPrices, setMaterialPrices] = useState([]);
            const [newPrice, setNewPrice] = useState({
                materialId: '',
                pricePerUnit: '',
                pricePerSheet: ''
            });

            const selectedAreaName = useMemo(() => {
                const area = savedAreas.find(a => a.id === selectedArea);
                return area ? area.name : '';
            }, [selectedArea, savedAreas]);

             const handleAreaSelect = (areaId) => {
                setSelectedArea(areaId);
             };
            
            useEffect(() => {
                if (!showMaterialPrices) {
                    setSelectedArea('');
                    setMaterialPrices([]);
                    
                }
            }, [showMaterialPrices]);

            useEffect(() => {
                if (!selectedArea) {
                    setMaterialPrices([]);
                    return;
                }

                const loadPrices = async () => {
                    try {
                        const prices = await getMaterialPricesByArea(selectedArea);
                        setMaterialPrices(prices);
                    } catch (error) {
                        console.error('Ошибка загрузки цен:', error);
                    }
                };
                
                loadPrices();
            }, [selectedArea]);

            const handleAddPrice = async () => {
                if (!selectedArea || !newPrice.materialId) return;

                try {
                    await saveMaterialPrice({
                        areaId: selectedArea,
                        materialId: newPrice.materialId,
                        pricePerUnit: newPrice.pricePerUnit || null,
                        pricePerSheet: newPrice.pricePerSheet || null
                    });
                    
                    // Обновляем список цен
                    const updatedPrices = await getMaterialPricesByArea(selectedArea);
                    setMaterialPrices(updatedPrices);
                    
                    // Сбрасываем форму
                    setNewPrice({ materialId: '', pricePerUnit: '', pricePerSheet: '' });
                } catch (error) {
                    console.error('Ошибка сохранения цены:', error);
                }
            };

            const handleDeletePrice = async (priceId) => {
                try {
                    await deleteMaterialPrice(priceId);
                    setMaterialPrices(materialPrices.filter(p => p.id !== priceId));
                } catch (error) {
                    console.error('Ошибка удаления цены:', error);
                }
            };

            return (
                <div className="mt-4">
                    <button 
                        onClick={() => setShowMaterialPrices(!showMaterialPrices)}
                        className="w-full text-left p-3 hover:dark:bg-dark-700 hover:bg-light-700 rounded-lg flex justify-between items-center"
                    >
                        <span>
                            <i className="fas fa-tags mr-2"></i>
                            Цены материалов
                        </span>
                        <i className={`fas fa-chevron-${showMaterialPrices ? 'up' : 'down'}`}></i>
                    </button>

                    {showMaterialPrices && (
                        <div className="mt-4 space-y-4">
                            <div className="dark:bg-dark-700 bg-light-700 p-4 rounded-lg">
                                <div className="mb-4">
                                    <label className="block text-sm font-medium mb-1">
                                        Участок
                                    </label>
                                    <SelectInput
                                        value={selectedAreaName}
                                        labelKey="name"
                                        valueKey="id"
                                        onSelect={handleAreaSelect}
                                        readonly_={true}
                                    >
                                        {savedAreas.map(area => (
                                            <option key={area.id} value={area.id}>{area.name}</option>
                                        ))}
                                    </SelectInput>
                                </div>

                                {selectedArea && (
                                    <>
                                        <div className="mb-4">
                                            <label className="block text-sm font-medium mb-1">
                                                Материал
                                            </label>
                                            <SelectInput 
                                                labelKey="name"
                                                valueKey="id"
                                                onSelect={(id) => setNewPrice({...newPrice, materialId: id})}
                                                readonly_={true}
                                            >
                                                {savedMaterials.map(material => (
                                                    <option key={material.id} value={material.id}>{material.name}</option>
                                                ))}
                                            </SelectInput>
                                            {/*
                                            <select
                                                value={newPrice.materialId}
                                                onChange={(e) => setNewPrice({...newPrice, materialId: e.target.value})}
                                                className="w-full dark:bg-dark-600 bg-light-600 border dark:border-dark-500 border-light-400 rounded-lg px-4 py-2 focus:outline-none focus:ring-1 focus:ring-primary-600"
                                            >
                                                <option value="">Выберите материал</option>
                                                {savedMaterials.map(material => (
                                                    <option key={material.id} value={material.id}>{material.name}</option>
                                                ))}
                                            </select>
                                            */}
                                        </div>

                                        <div className="grid grid-cols-2 gap-4 mb-4">
                                            <div>
                                                <label className="block text-sm font-medium mb-1">
                                                    Цена за штуку
                                                </label>
                                                <input
                                                    type="number"
                                                    value={newPrice.pricePerUnit}
                                                    onChange={(e) => setNewPrice({...newPrice, pricePerUnit: e.target.value})}
                                                    className="w-full dark:bg-dark-600 bg-light-600 border dark:border-dark-500 border-light-400 rounded-lg px-4 py-2 focus:outline-none focus:ring-1 focus:ring-primary-600"
                                                    placeholder="0.00"
                                                />
                                            </div>
                                            <div>
                                                <label className="block text-sm font-medium mb-1">
                                                    Цена за лист
                                                </label>
                                                <input
                                                    type="number"
                                                    value={newPrice.pricePerSheet}
                                                    onChange={(e) => setNewPrice({...newPrice, pricePerSheet: e.target.value})}
                                                    className="w-full dark:bg-dark-600 bg-light-600 border dark:border-dark-500 border-light-400 rounded-lg px-4 py-2 focus:outline-none focus:ring-1 focus:ring-primary-600"
                                                    placeholder="0.00"
                                                />
                                            </div>
                                        </div>

                                        <button
                                            onClick={handleAddPrice}
                                            className="bg-primary-600 hover:bg-primary-700 text-white px-4 py-2 rounded-lg w-full"
                                        >
                                            <i className="fas fa-plus mr-2"></i>
                                            Добавить цену
                                        </button>
                                    </>
                                )}
                            </div>

                            {selectedArea && materialPrices.length > 0 && (
                                <div className="dark:bg-dark-700 bg-light-700 rounded-lg p-4">
                                    <h4 className="font-medium mb-3">Текущие цены</h4>
                                    <div className="space-y-3">
                                        {materialPrices.map(price => {
                                            const material = savedMaterials.find(m => m.id === price.materialId);
                                            return (
                                                <div key={price.id} className="flex justify-between items-center p-3 dark:bg-dark-600 bg-light-600 rounded-lg">
                                                    <div>
                                                        <div className="font-medium">{material?.name || 'Неизвестный материал'}</div>
                                                        <div className="text-sm dark:text-gray-400 text-gray-600">
                                                            {price.pricePerUnit && `Штука: ${price.pricePerUnit} ₽`}
                                                            {price.pricePerUnit && price.pricePerSheet && ' • '}
                                                            {price.pricePerSheet && `Лист: ${price.pricePerSheet} ₽`}
                                                        </div>
                                                    </div>
                                                    <button
                                                        onClick={() => handleDeletePrice(price.id)}
                                                        className="text-red-500 hover:text-red-400"
                                                    >
                                                        <i className="fas fa-times"></i>
                                                    </button>
                                                </div>
                                            );
                                        })}
                                    </div>
                                </div>
                            )}
                        </div>
                    )}
                </div>
            );
        }

        // Компонент заголовка
        function Header() {
            return (
                <header className="flex items-center justify-between">
                    <div className="flex items-center">
                        <div className="bg-primary-600 w-10 h-10 rounded-lg flex items-center justify-center">
                            <i className="fas fa-clock text-white text-xl"></i>
                        </div>
                        <h1 className="ml-3 text-2xl font-bold dark:text-gray-200 text-gray-800">WorkShift <span className="text-primary-600">Pro</span></h1>
                    </div>
                </header>
            );
        }
        
        function TabButton({ children, active, onClick, icon, label, theme }) {
            return (
                <button 
                    onClick={onClick}
                    className={`flex items-center justify-center px-4 py-2 rounded-2xl transition-all ${
                        active 
                            ? 'bg-dark-900 text-white'
                            : 'text-gray-600'
                    }`}
                >
                    <i className={`fas fa-${icon} text-lg ${active ? 'mr-2' : ''}`}></i>
                    {active && <span className="text-sm font-medium">{label}</span>}
                </button>
            );
        }
        
        // Компонент вкладки "Мои смены"
        function ShiftsTab({
            shifts,
            onAddShift,
            onAddArea,
            onEditArea,
            onDeleteShift,
            onDeleteArea,
            theme,
            savedAreas,
            filters,
            onFilterChange,
            onResetFilters,
            isFiltering,
            isFilteringNow,
            formatHoursToHMM
        }) {
            // Форматируем дату в dd.mm.yyyy
            const formatDate = (dateString) => {
                if (!dateString) return '';
                const [year, month, day] = dateString.split('-');
                return `${day}.${month}.${year}`;
            };

            const calculateTotals = (areas) => {
                let totalQuantity = 0;
                let totalSheets = 0;

                areas?.forEach(area => {
                    area.materials?.forEach(material => {
                        totalQuantity += parseInt(material.quantity) || 0;
                        totalSheets += parseInt(material.sheets) || 0;
                    });
                });

                return { totalQuantity, totalSheets };
            };

            const calculateShiftTotalHours = (shift) => {
                if (!shift.areas || shift.areas.length === 0) return null;
                
                // Находим самое раннее начало и самый поздний конец среди всех участков
                const startTimes = shift.areas.map(area => area.startTime);
                const endTimes = shift.areas.map(area => area.endTime);
                
                const earliestStart = startTimes.reduce((earliest, current) => 
                    current < earliest ? current : earliest);
                const latestEnd = endTimes.reduce((latest, current) => 
                    current > latest ? current : latest);
                
                // Вычисляем общее время смены
                const totalHours = calculateWorkHours(
                    earliestStart, 
                    latestEnd, 
                    shift.lunchStart || '12:00', 
                    shift.lunchEnd || '13:00'
                );
                
                return {
                    start: earliestStart,
                    end: latestEnd,
                    total: totalHours
                };
            };

            return (
                <div>
                    <div className="flex justify-between items-center mb-4">
                        <h2 className="text-xl font-bold">История смен</h2>
                        <button 
                            onClick={onAddShift}
                            className="bg-primary-600 hover:bg-primary-700 text-white px-4 py-2 rounded-lg flex items-center"
                        >
                            <i className="fas fa-plus mr-2"></i>
                            Новая смена
                        </button>
                    </div>
                    
                    {/* Панель фильтров */}
                    <div className="dark:bg-dark-800 bg-light-800 rounded-xl p-4 mb-6 shadow">
                        <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
                            {/* Сортировка */}
                            <div>
                                <label className="block text-sm font-medium mb-1">
                                    <i className="fas fa-sort mr-2"></i>
                                    Сортировка
                                </label>
                                <select
                                    value={filters.sortOrder}
                                    onChange={(e) => onFilterChange('sortOrder', e.target.value)}
                                    className="w-full dark:bg-dark-700 bg-light-700 border dark:border-dark-600 border-light-500 rounded-lg px-4 py-2 focus:outline-none focus:ring-1 focus:ring-primary-600"
                                >
                                    <option value="desc">Сначала новые</option>
                                    <option value="asc">Сначала старые</option>
                                </select>
                            </div>
                            
                            {/* Фильтр по дате */}
                            <div>
                                <label className="block text-sm font-medium mb-1">
                                    <i className="fas fa-calendar mr-2"></i>
                                    Период
                                </label>
                                <div className="grid grid-cols-2 gap-2">
                                    <input
                                        type="date"
                                        value={filters.startDate}
                                        onChange={(e) => onFilterChange('startDate', e.target.value)}
                                        className="w-full dark:bg-dark-700 bg-light-700 border dark:border-dark-600 border-light-500 rounded-lg px-3 py-2 text-sm focus:outline-none focus:ring-1 focus:ring-primary-600"
                                        placeholder="От"
                                    />
                                    <input
                                        type="date"
                                        value={filters.endDate}
                                        onChange={(e) => onFilterChange('endDate', e.target.value)}
                                        className="w-full dark:bg-dark-700 bg-light-700 border dark:border-dark-600 border-light-500 rounded-lg px-3 py-2 text-sm focus:outline-none focus:ring-1 focus:ring-primary-600"
                                        placeholder="До"
                                    />
                                </div>
                            </div>
                            
                            {/* Фильтр по участку */}
                            <div>
                                <label className="block text-sm font-medium mb-1">
                                    <i className="fas fa-compass mr-2"></i>
                                    Участок
                                </label>
                                <input
                                    type="text"
                                    value={filters.areaName}
                                    onChange={(e) => onFilterChange('areaName', e.target.value)}
                                    className="w-full dark:bg-dark-700 bg-light-700 border dark:border-dark-600 border-light-500 rounded-lg px-4 py-2 focus:outline-none focus:ring-1 focus:ring-primary-600"
                                    placeholder="Название участка"
                                />
                            </div>
                            
                            {/* Фильтр по материалу */}
                            <div>
                                <label className="block text-sm font-medium mb-1">
                                    <i className="fas fa-boxes mr-2"></i>
                                    Материал
                                </label>
                                <input
                                    type="text"
                                    value={filters.materialName}
                                    onChange={(e) => onFilterChange('materialName', e.target.value)}
                                    className="w-full dark:bg-dark-700 bg-light-700 border dark:border-dark-600 border-light-500 rounded-lg px-4 py-2 focus:outline-none focus:ring-1 focus:ring-primary-600"
                                    placeholder="Название материала"
                                />
                            </div>
                            
                            {/* Фильтр по количеству материала */}
                            <div>
                                <label className="block text-sm font-medium mb-1">
                                    <i className="fas fa-hashtag mr-2"></i>
                                    Количество материала
                                </label>
                                <div className="grid grid-cols-2 gap-2">
                                    <input
                                        type="number"
                                        value={filters.minQuantity}
                                        onChange={(e) => onFilterChange('minQuantity', e.target.value)}
                                        className="w-full dark:bg-dark-700 bg-light-700 border dark:border-dark-600 border-light-500 rounded-lg px-3 py-2 text-sm focus:outline-none focus:ring-1 focus:ring-primary-600"
                                        placeholder="Мин"
                                        min="0"
                                    />
                                    <input
                                        type="number"
                                        value={filters.maxQuantity}
                                        onChange={(e) => onFilterChange('maxQuantity', e.target.value)}
                                        className="w-full dark:bg-dark-700 bg-light-700 border dark:border-dark-600 border-light-500 rounded-lg px-3 py-2 text-sm focus:outline-none focus:ring-1 focus:ring-primary-600"
                                        placeholder="Макс"
                                        min="0"
                                    />
                                </div>
                            </div>
                            
                            {/* Фильтр по листам */}
                            <div>
                                <label className="block text-sm font-medium mb-1">
                                    <i className="fas fa-layer-group mr-2"></i>
                                    Листы
                                </label>
                                <div className="grid grid-cols-2 gap-2">
                                    <input
                                        type="number"
                                        value={filters.minSheets}
                                        onChange={(e) => onFilterChange('minSheets', e.target.value)}
                                        className="w-full dark:bg-dark-700 bg-light-700 border dark:border-dark-600 border-light-500 rounded-lg px-3 py-2 text-sm focus:outline-none focus:ring-1 focus:ring-primary-600"
                                        placeholder="Мин"
                                        min="0"
                                    />
                                    <input
                                        type="number"
                                        value={filters.maxSheets}
                                        onChange={(e) => onFilterChange('maxSheets', e.target.value)}
                                        className="w-full dark:bg-dark-700 bg-light-700 border dark:border-dark-600 border-light-500 rounded-lg px-3 py-2 text-sm focus:outline-none focus:ring-1 focus:ring-primary-600"
                                        placeholder="Макс"
                                        min="0"
                                    />
                                </div>
                            </div>
                            
                            {/* Фильтр по оплате */}
                            <div>
                                <label className="block text-sm font-medium mb-1">
                                    <i className="fas fa-money-bill-wave mr-2"></i>
                                    Оплата (₽)
                                </label>
                                <div className="grid grid-cols-2 gap-2">
                                    <input
                                        type="number"
                                        value={filters.minPayment}
                                        onChange={(e) => onFilterChange('minPayment', e.target.value)}
                                        className="w-full dark:bg-dark-700 bg-light-700 border dark:border-dark-600 border-light-500 rounded-lg px-3 py-2 text-sm focus:outline-none focus:ring-1 focus:ring-primary-600"
                                        placeholder="Мин"
                                        min="0"
                                        step="0.01"
                                    />
                                    <input
                                        type="number"
                                        value={filters.maxPayment}
                                        onChange={(e) => onFilterChange('maxPayment', e.target.value)}
                                        className="w-full dark:bg-dark-700 bg-light-700 border dark:border-dark-600 border-light-500 rounded-lg px-3 py-2 text-sm focus:outline-none focus:ring-1 focus:ring-primary-600"
                                        placeholder="Макс"
                                        min="0"
                                        step="0.01"
                                    />
                                </div>
                            </div>
                        </div>
                        
                        <div className="flex justify-end mt-4">
                            <button
                                onClick={onResetFilters}
                                className="dark:bg-dark-700 bg-light-700 hover:dark:bg-dark-600 hover:bg-light-600 px-4 py-2 rounded-lg text-sm"
                            >
                                <i className="fas fa-times mr-2"></i>
                                Сбросить фильтры
                            </button>
                        </div>
                    </div>
                    
                    {isFiltering ? (
                        <div className="flex justify-center items-center py-12">
                            <i className="fas fa-circle-notch fa-spin text-4xl text-primary-600"></i>
                        </div>
                    ) : shifts.length === 0 ? (
                        <div className="dark:bg-dark-800 bg-light-800 rounded-xl p-8 text-center">
                            <i className="fas fa-calendar text-5xl mb-4 dark:text-gray-500 text-gray-400"></i>
                            <h3 className="text-xl font-medium mb-2">Смены не найдены</h3>
                            <p className="dark:text-gray-500 text-gray-600 mb-4">
                                {isFilteringNow == false ? 'У вас пока нет смен' : 'Попробуйте изменить параметры фильтрации'}
                            </p>
                            {isFilteringNow == false && (
                                <button 
                                    onClick={onAddShift}
                                    className="bg-primary-600 hover:bg-primary-700 text-white px-4 py-2 rounded-lg"
                                >
                                    Добавить первую смену
                                </button>
                            )}
                        </div>
                    ) : (
                        <div className="space-y-4">
                            {shifts.map(shift => (
                                <div key={shift.id} className="dark:bg-dark-800 bg-light-800 rounded-xl overflow-hidden shadow">
                                    <div className="flex justify-between items-center px-6 pt-6">
                                        <div>
                                            <h3 className="text-lg font-bold">{formatDate(shift.date)}</h3>
                                            {shift.areas?.length > 0 && (
                                                <>
                                                    <p className="text-sm text-gray-400 mt-1">
                                                        Смена: {calculateShiftTotalHours(shift).start} - {calculateShiftTotalHours(shift).end} <br />
                                                        Всего: {formatHoursToHMM(parseFloat(calculateShiftTotalHours(shift).total))}
                                                    </p>
                                                    {shift.lunchStart && shift.lunchEnd && (
                                                        <p className="text-sm text-gray-400">
                                                            Обед: {shift.lunchStart} - {shift.lunchEnd}
                                                        </p>
                                                    )}
                                                </>
                                            )}
                                        </div>
                                            <div className="flex items-center gap-3">
                                                <button 
                                                    onClick={() => onAddArea(shift.id)}
                                                className="mr-2 dark:bg-primary bg-primary text-white px-4 py-2 rounded-lg text-sm flex items-center"
                                            >
                                                <i className="fas fa-plus mr-2"></i>
                                                Участок
                                            </button>
                                            <button 
                                                onClick={() => onDeleteShift(shift.id)}
                                                className="text-red-500"
                                            >
                                                <i className="fas fa-times"></i>
                                            </button>
                                        </div>
                                    </div>
                                    
                                    {shift.areas?.length > 0 ? (
                                        <div>
                                            {shift.areas.map((area, areaIndex) => {
                                                const areaTotals = calculateTotals([area]);
                                                return (
                                                    <div key={areaIndex} className="px-6 py-3">
                                                        <div className="flex justify-between items-start mb-4">
                                                            <div>
                                                                <h4 className="font-medium">{area.name}</h4>
                                                                <p className="dark:text-gray-400 text-gray-600 text-sm">
                                                                    {area.startTime} - {area.endTime} ({formatHoursToHMM(parseFloat(area.workHours))})
                                                                </p>
                                                                {area.description && (
                                                                    <p className="dark:text-gray-400 text-gray-600 text-sm mt-1">
                                                                        {area.description}
                                                                    </p>
                                                                )}
                                                            </div>
                                                            <div className="flex items-center gap-2">
                                                                <div className="text-green-500 font-medium">{area.payment} ₽</div>
                                                            </div>
                                                        </div>
                                                        
                                                        {area.materials?.length > 0 && (
                                                            <>
                                                                <div className="mt-4">
                                                                    <h5 className="text-sm font-medium dark:text-gray-400 text-gray-600 mb-3">
                                                                        <i className="fas fa-boxes mr-1"></i>
                                                                        Материалы:
                                                                    </h5>
                                                                    
                                                                    {/* Для компьютеров (таблица) */}
                                                                    <div className="hidden md:block w-full dark:bg-dark-700 bg-light-700 rounded-lg p-3">
                                                                        <div className="grid grid-cols-12 gap-2 text-sm font-medium dark:text-gray-400 text-gray-500 mb-2">
                                                                            <div className="col-span-6">Название материала</div>
                                                                            <div className="col-span-3">Количество</div>
                                                                            <div className="col-span-3">Листы</div>
                                                                        </div>
                                                                        
                                                                        {area.materials.map((material, matIndex) => (
                                                                            <div 
                                                                                key={matIndex} 
                                                                                className="grid grid-cols-12 gap-2 py-2 border-b dark:border-dark-600 border-light-500 last:border-0 items-center"
                                                                            >
                                                                                <div className="col-span-6 min-w-0">
                                                                                    <span className="whitespace-nowrap overflow-hidden text-ellipsis block">
                                                                                        {material.name}
                                                                                    </span>
                                                                                </div>
                                                                                <div className="col-span-3">{material.quantity || '-'}</div>
                                                                                <div className="col-span-3">{material.sheets || '-'}</div>
                                                                            </div>
                                                                        ))}
                                                                        
                                                                        {/* Итоговая строка для компьютеров */}
                                                                        <div className="grid grid-cols-12 gap-2 py-2 pt-3 border-t-2 dark:border-dark-500 border-light-400 font-medium">
                                                                            <div className="col-span-6">Итого:</div>
                                                                            <div className="col-span-3">{areaTotals.totalQuantity}</div>
                                                                            <div className="col-span-3">{areaTotals.totalSheets}</div>
                                                                        </div>
                                                                    </div>
                                                                    
                                                                    {/* Для мобильных (карточки) */}
                                                                    <div className="md:hidden space-y-3">
                                                                        {area.materials.map((material, matIndex) => (
                                                                            <div 
                                                                                key={matIndex} 
                                                                                className="dark:bg-dark-700 bg-light-700 rounded-lg p-4"
                                                                            >
                                                                                <div className="flex justify-between items-center pb-2">
                                                                                    <span className="text-right whitespace-nowrap">
                                                                                        {material.name}
                                                                                    </span>
                                                                                </div>
                                                                                
                                                                                <div className="h-px w-full dark:bg-dark-600 bg-light-500 my-2"></div>
                                                                                
                                                                                <div className="flex justify-between items-center py-2">
                                                                                    <span className="font-medium">Количество:</span>
                                                                                    <span>{material.quantity || '-'}</span>
                                                                                </div>
                                                                                
                                                                                <div className="h-px w-full dark:bg-dark-600 bg-light-500 my-2"></div>
                                                                                
                                                                                <div className="flex justify-between items-center pt-2">
                                                                                    <span className="font-medium">Листы:</span>
                                                                                    <span>{material.sheets || '-'}</span>
                                                                                </div>
                                                                            </div>
                                                                        ))}
                                                                        
                                                                        <div className="flex justify-between mt-3 pt-2 border-t dark:border-dark-600 border-light-500">
                                                                            <span className="text-sm font-medium dark:text-gray-400 text-gray-500">
                                                                                Итого по участку:
                                                                            </span>
                                                                            <div className="flex gap-4">
                                                                                <span className="text-sm">
                                                                                    <span className="dark:text-gray-400 text-gray-500">Кол-во: </span>
                                                                                    <span className="font-medium">{areaTotals.totalQuantity}</span>
                                                                                </span>
                                                                                <span className="text-sm">
                                                                                    <span className="dark:text-gray-400 text-gray-500">Листы: </span>
                                                                                    <span className="font-medium">{areaTotals.totalSheets}</span>
                                                                                </span>
                                                                            </div>
                                                                        </div>

                                                                    </div>
                                                                </div>
                                                            </>
                                                        )}
                                                        
                                                        <div className="flex justify-center mt-3 space-x-2">
                                                            <button 
                                                                onClick={() => onEditArea(shift.id, areaIndex)}
                                                                className="flex-1 text-md text-white px-5 py-2 bg-primary rounded-lg"
                                                            >
                                                                Редактировать
                                                            </button>
                                                            <button 
                                                                onClick={() => onDeleteArea(shift.id, areaIndex)}
                                                                className="flex-1 text-sm px-5 py-2 bg-red-500 rounded-lg text-white"
                                                            >
                                                                Удалить
                                                            </button>
                                                        </div>
                                                    </div>
                                                );
                                            })}

                                            {shift.areas?.length > 0 && (
                                                <div className="p-4 dark:bg-dark-700 bg-light-700">
                                                    <div className="flex flex-col font-medium">
                                                        <span className="flex justify-between">
                                                            <span>Итого за смену:</span>
                                                            <span className="text-green-500">
                                                                {shift.areas?.reduce((sum, area) => sum + area.payment, 0).toFixed(2)} ₽
                                                            </span>
                                                        </span>
                                                        <div className="flex flex-col">
                                                            <span className="flex justify-between">
                                                                <span className="dark:text-gray-400 text-gray-600">Количество: </span>
                                                                <span>{calculateTotals(shift.areas).totalQuantity}</span>
                                                            </span>
                                                            <span className="flex justify-between">
                                                                <span className="dark:text-gray-400 text-gray-600">Листы: </span>
                                                                <span>{calculateTotals(shift.areas).totalSheets}</span>
                                                            </span>
                                                        </div>
                                                    </div>
                                                </div>
                                            )}
                                        </div>
                                    ) : (
                                        <div className="p-6 text-center dark:text-gray-500 text-gray-600">
                                            <i className="fas fa-map-marked-alt mr-1"></i>
                                            Участки не добавлены
                                        </div>
                                    )}    
                                </div>
                            ))}
                        </div>
                    )}
                </div>
            );
        }
        
        // Компонент вкладки "Статистика"
        function StatsTab({ shifts, theme }) {
            // Расчет общей статистики
             const totalStats = shifts.reduce((acc, shift) => {
                const shiftEarnings = shift.areas?.reduce((sum, area) => sum + area.payment, 0) || 0;
                const shiftHours = shift.areas?.reduce((sum, area) => sum + parseFloat(area.workHours), 0) || 0;
        
                return {
                    totalEarnings: acc.totalEarnings + shiftEarnings,
                    totalHours: acc.totalHours + shiftHours,
                    totalShifts: acc.totalShifts + 1,
                    totalAreas: acc.totalAreas + (shift.areas?.length || 0),
                    totalLunchHours: acc.totalLunchHours + (shift.areas?.length > 0 ? 1 : 0) // Учитываем 1 обед на смену
                };
            }, {
                totalEarnings: 0,
                totalHours: 0,
                totalShifts: 0,
                totalAreas: 0,
                totalLunchHours: 0
            });

            const formatDate = (dateString) => {
                if (!dateString) return '';
                const [year, month, day] = dateString.split('-');
                return `${day}.${month}.${year}`;
            };

            return (
                <div>
                    <h2 className="text-xl font-bold mb-6">Статистика</h2>
                    
                    <div className="grid grid-cols-1 md:grid-cols-4 gap-6 mb-8">
                        <StatCard 
                            title="Всего смен" 
                            value={totalStats.totalShifts} 
                            icon="calendar-day" 
                            theme={theme}
                        />
                        <StatCard 
                            title="Всего часов" 
                            value={totalStats.totalHours.toFixed(2)} 
                            icon="clock" 
                            theme={theme}
                        />
                        <StatCard 
                            title="Всего участков" 
                            value={totalStats.totalAreas} 
                            icon="compass" 
                            theme={theme}
                        />
                        <StatCard 
                            title="Общий заработок" 
                            value={`${totalStats.totalEarnings.toFixed(2)} ₽`} 
                            icon="money-bill-wave" 
                            theme={theme}
                        />
                    </div>
                    
                    <div className="dark:bg-dark-800 bg-light-800 rounded-xl p-6 shadow">
                        <h3 className="font-medium mb-4">
                            <i className="fas fa-history mr-2"></i>
                            Последние смены
                        </h3>
                        {shifts.length > 0 ? (
                            <div className="space-y-4">
                                {shifts.slice(0, 5).map(shift => (
                                    <div key={shift.id} className="flex justify-between items-center dark:bg-dark-700 bg-light-700 p-4 rounded-lg">
                                        <div>
                                            <div className="font-medium">
                                                <i className="fas fa-calendar-day mr-2"></i>
                                                {formatDate(shift.date)}
                                            </div>
                                            <div className="text-sm dark:text-gray-400 text-gray-600">
                                                {shift.areas?.length || 0} участков, {formatHoursToHMM(shift.areas?.reduce((sum, area) => sum + parseFloat(area.workHours), 0) || 0)}
                                            </div>
                                        </div>
                                        <div className="text-green-500 font-medium">
                                            {shift.areas?.reduce((sum, area) => sum + area.payment, 0).toFixed(2)} ₽
                                        </div>
                                    </div>
                                ))}
                            </div>
                        ) : (
                            <div className="text-center dark:text-gray-500 text-gray-600 py-8">
                                <i className="fas fa-database mr-2"></i>
                                Нет данных для отображения
                            </div>
                        )}
                    </div>
                </div>
            );
        }
        
        // Компонент карточки статистики
        function StatCard({ title, value, icon, theme }) {
            return (
                <div className="dark:bg-dark-800 bg-light-800 rounded-xl p-5 shadow">
                    <div className="flex justify-between items-start">
                        <div>
                            <h3 className="dark:text-gray-400 text-gray-600 text-sm">{title}</h3>
                            <p className="text-2xl font-bold mt-1">{value}</p>
                        </div>
                        <div className="dark:bg-dark-700 bg-light-700 p-3 rounded-lg text-xl">
                            <i className={`fas fa-${icon}`}></i>
                        </div>
                    </div>
                </div>
            );
        }
        
        // Компонент вкладки "Настройки"
        function SettingsTab({
            theme,
            toggleTheme,
            savedAreas,
            onAddSavedArea,
            onDeleteSavedArea,
            showAreaSettings,
            setShowAreaSettings,
            showMaterialSettings,
            setShowMaterialSettings,
            savedMaterials,
            onAddSavedMaterial,
            onDeleteSavedMaterial,
            SelectInput
        }) {
            const [newAreaName, setNewAreaName] = useState('');
            const [newMaterialName, setNewMaterialName] = useState('');           
            const [showMaterialPrices, setShowMaterialPrices] = useState(false);

            const handleAddArea = () => {
                if (newAreaName.trim()) {
                    onAddSavedArea({
                        name: newAreaName.trim(),
                        description: ''
                    });
                    setNewAreaName('');
                }
            };

            const handleAddMaterial = () => {
                if (newMaterialName.trim()) {
                    onAddSavedMaterial({
                        name: newMaterialName.trim()
                    });
                    setNewMaterialName('');
                }
            };
            
            return (
                <div>
                    <h2 className="text-xl font-bold mb-6">
                        <i className="fas fa-cog mr-2"></i>
                        Настройки
                    </h2>
                    
                    <div className="dark:bg-dark-800 bg-light-800 rounded-xl overflow-hidden shadow">
                        <div className="p-6 border-b dark:border-dark-700 border-light-600">
                            <h3 className="font-medium mb-4">
                                <i className="fas fa-user mr-2"></i>
                                Аккаунт
                            </h3>
                            <div className="space-y-3">
                                <button className="w-full text-left p-3 hover:dark:bg-dark-700 hover:bg-light-700 rounded-lg">
                                    <i className="fas fa-user-edit mr-2"></i>
                                    Профиль
                                </button>
                                <button className="w-full text-left p-3 hover:dark:bg-dark-700 hover:bg-light-700 rounded-lg">
                                    <i className="fas fa-bell mr-2"></i>
                                    Уведомления
                                </button>
                            </div>
                        </div>
                        
                        <div className="p-6 border-b dark:border-dark-700 border-light-600">
                            <h3 className="font-medium mb-4">
                                <i className="fas fa-mobile-alt mr-2"></i>
                                Приложение
                            </h3>
                            <div className="space-y-3">
                                <div className="flex items-center justify-between p-3">
                                    <div>
                                        <i className="fas fa-moon mr-2"></i>
                                        Тёмная тема
                                    </div>
                                    <label className="relative inline-flex items-center cursor-pointer">
                                        <input 
                                            type="checkbox" 
                                            className="sr-only peer" 
                                            checked={theme === 'dark'}
                                            onChange={() => toggleTheme(theme === 'dark' ? 'light' : 'dark')}
                                        />
                                        <div className="w-11 h-6 bg-gray-200 rounded-full peer dark:bg-gray-700 peer-checked:after:translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-[2px] after:left-[1.5px] after:bg-white after:border-gray-300 after:border after:rounded-full after:h-5 after:w-5 dark:border-gray-600 peer-checked:bg-primary-600"></div>
                                    </label>
                                </div>
                                <button className="w-full text-left p-3 hover:dark:bg-dark-700 hover:bg-light-700 rounded-lg">
                                    <i className="fas fa-database mr-2"></i>
                                    Резервные копии
                                </button>
                            </div>
                        </div>
                        
                        <div className="p-6">
                            <h3 className="font-medium mb-4">
                                <i className="fas fa-folder-plus mr-2"></i>
                                Управление данными
                            </h3>
                            
                            <button 
                                onClick={() => setShowAreaSettings(!showAreaSettings)}
                                className="w-full text-left p-3 hover:dark:bg-dark-700 hover:bg-light-700 rounded-lg flex justify-between items-center"
                            >
                                <span>
                                    <i className="fas fa-compass mr-2"></i>
                                    Управление участками
                                </span>
                                <i className={`fas fa-chevron-${showAreaSettings ? 'up' : 'down'}`}></i>
                            </button>
                            
                            {showAreaSettings && (
                                <div className="mt-4 space-y-4">
                                    <div className="flex flex-col gap-2">
                                        <input
                                            type="text"
                                            value={newAreaName}
                                            onChange={(e) => setNewAreaName(e.target.value)}
                                            className="flex-1 dark:bg-dark-700 bg-light-700 border dark:border-dark-600 border-light-500 rounded-lg px-4 py-2 focus:outline-none focus:ring-1 focus:ring-primary-600"
                                            placeholder="Название участка"
                                        />
                                        <button
                                            onClick={handleAddArea}
                                            className="bg-primary-600 hover:bg-primary-700 text-white px-4 py-2 rounded-lg"
                                        >
                                            <i className="fas fa-plus mr-2"></i>
                                            Добавить участок
                                        </button>
                                    </div>
                                    
                                    {savedAreas.length > 0 ? (
                                        <div className="dark:bg-dark-700 bg-light-700 rounded-lg p-3">
                                            <div>
                                                {savedAreas.map((area) => (
                                                    <div key={area.id} className="bg-light-600 dark:bg-dark-600 mt-3 p-4 flex justify-between items-center rounded-lg">
                                                        <div>
                                                            <div className="font-medium">{area.name}</div>
                                                        </div>
                                                        <button
                                                            onClick={() => onDeleteSavedArea(area.id)}
                                                            className="text-red-500 hover:text-red-400 font-medium"
                                                        >
                                                            <i className="fas fa-times"></i>
                                                        </button>
                                                    </div>
                                                ))}
                                            </div>
                                        </div>
                                    ) : (
                                        <div className="text-center dark:text-gray-500 text-gray-600 py-4">
                                            <i className="fas fa-map-marked-alt mr-2"></i>
                                            Нет сохраненных участков
                                        </div>
                                    )}
                                </div>
                            )}

                            <button 
                                onClick={() => setShowMaterialSettings(!showMaterialSettings)}
                                className="w-full text-left p-3 hover:dark:bg-dark-700 hover:bg-light-700 rounded-lg flex justify-between items-center mt-4"
                            >
                                <span>
                                    <i className="fas fa-boxes mr-2"></i>
                                    Управление материалами
                                </span>
                                <i className={`fas fa-chevron-${showMaterialSettings ? 'up' : 'down'}`}></i>
                            </button>
                            
                            {showMaterialSettings && (
                                <div className="mt-4 space-y-4">
                                    <div className="flex flex-col gap-2">
                                        <input
                                            type="text"
                                            value={newMaterialName}
                                            onChange={(e) => setNewMaterialName(e.target.value)}
                                            className="flex-1 dark:bg-dark-700 bg-light-700 border dark:border-dark-600 border-light-500 rounded-lg px-4 py-2 focus:outline-none focus:ring-1 focus:ring-primary-600"
                                            placeholder="Название материала"
                                        />
                                        <button
                                            onClick={handleAddMaterial}
                                            className="bg-primary-600 hover:bg-primary-700 text-white px-4 py-2 rounded-lg"
                                        >
                                            <i className="fas fa-plus mr-2"></i>
                                            Добавить материал
                                        </button>
                                    </div>
                                    
                                    {savedMaterials.length > 0 ? (
                                        <div className="dark:bg-dark-700 bg-light-700 rounded-lg p-3">
                                            <div className="space-y-3">
                                                {savedMaterials.map((material) => (
                                                    <div key={material.id} className="bg-light-600 dark:bg-dark-600 p-4 flex justify-between items-center rounded-lg">
                                                        <div className="font-medium">{material.name}</div>
                                                        <button
                                                            onClick={() => onDeleteSavedMaterial(material.id)}
                                                            className="text-red-500 hover:text-red-400 font-medium"
                                                        >
                                                            <i className="fas fa-times"></i>
                                                        </button>
                                                    </div>
                                                ))}
                                            </div>
                                        </div>
                                    ) : (
                                        <div className="text-center dark:text-gray-500 text-gray-600 py-4">
                                            <i className="fas fa-boxes mr-2"></i>
                                            Нет сохраненных материалов
                                        </div>
                                    )}
                                </div>
                            )}
                            <MaterialPricesSettings
                                savedAreas={savedAreas}
                                savedMaterials={savedMaterials}
                                theme={theme}
                                showMaterialPrices={showMaterialPrices}
                                setShowMaterialPrices={setShowMaterialPrices}
                                SelectInput={SelectInput}
                            />
                        </div>
                    </div>
                </div>
            );
        }
        
        // Компонент формы добавления смены
        function ShiftForm({ onAdd, onCancel, theme }) {
            const [date, setDate] = useState(new Date().toISOString().split('T')[0]);
            const [lunchStart, setLunchStart] = useState('12:00'); // По умолчанию обед с 12:00
            const [lunchEnd, setLunchEnd] = useState('13:00');   // до 13:00

            const handleSubmit = (e) => {
                e.preventDefault();
                onAdd({
                    date,
                    lunchStart,
                    lunchEnd
                });
            };
            
            return (
                <div className="fixed inset-0 dark:bg-black bg-gray-800 dark:bg-opacity-70 bg-opacity-80 flex items-center justify-center p-4 z-50">
                    <div className={`${theme === 'dark' ? 'bg-dark-800' : 'bg-light-800'} rounded-xl w-full max-w-md shadow-lg`}>
                        <div className="p-6">
                            <div className="flex justify-between items-center mb-6">
                                <h2 className="text-xl font-bold">
                                    <i className="fas fa-plus-circle mr-2"></i>
                                    Новая смена
                                </h2>
                                <button onClick={onCancel} className="dark:text-gray-500 text-gray-600 hover:dark:text-gray-300 hover:text-gray-800">
                                    <i className="fas fa-times"></i>
                                </button>
                            </div>
                            
                            <form onSubmit={handleSubmit}>
                                <div className="space-y-4">
                                    <div>
                                <label className="block text-sm font-medium mb-1">
                                    <i className="fas fa-calendar-day mr-2"></i>
                                    Дата
                                </label>
                                <input 
                                    type="date" 
                                    value={date}
                                    onChange={(e) => setDate(e.target.value)}
                                    className="w-full dark:bg-dark-700 bg-light-700 border dark:border-dark-600 border-light-500 rounded-lg px-4 py-2 focus:outline-none focus:ring-1 focus:ring-primary-600"
                                    required
                                />
                            </div>
                            
                            {/* Поля времени обеда */}
                            <div className="grid grid-cols-2 gap-4">
                                <div>
                                    <label className="block text-sm font-medium mb-1">
                                        <i className="fas fa-utensils mr-2"></i>
                                        Обед с
                                    </label>
                                    <input 
                                        type="time" 
                                        value={lunchStart}
                                        onChange={(e) => setLunchStart(e.target.value)}
                                        className="w-full dark:bg-dark-700 bg-light-700 border dark:border-dark-600 border-light-500 rounded-lg px-4 py-2 focus:outline-none focus:ring-1 focus:ring-primary-600"
                                    />
                                </div>
                                <div>
                                    <label className="block text-sm font-medium mb-1">
                                        <i className="fas fa-utensils mr-2"></i>
                                        Обед до
                                    </label>
                                    <input 
                                        type="time" 
                                        value={lunchEnd}
                                        onChange={(e) => setLunchEnd(e.target.value)}
                                        className="w-full dark:bg-dark-700 bg-light-700 border dark:border-dark-600 border-light-500 rounded-lg px-4 py-2 focus:outline-none focus:ring-1 focus:ring-primary-600"
                                    />
                                </div>
                            </div>
                                    
                                    <div className="flex gap-3 pt-4">
                                        <button
                                            type="button"
                                            onClick={onCancel}
                                            className="flex-1 dark:bg-dark-700 bg-light-700 hover:dark:bg-dark-600 hover:bg-light-600 py-3 rounded-lg flex items-center justify-center"
                                        >
                                            <i className="fas fa-times mr-2"></i>
                                            Отмена
                                        </button>
                                        <button
                                            type="submit"
                                            className="flex-1 bg-primary-600 hover:bg-primary-700 py-3 rounded-lg flex items-center justify-center text-white"
                                        >
                                            <i className="fas fa-check mr-2"></i>
                                            Создать
                                        </button>
                                    </div>
                                </div>
                            </form>
                        </div>
                    </div>
                </div>
            );
        }
        
// Компонент формы добавления/редактирования участка
function AreaForm({
    shiftId,
    areaIndex,
    shift,
    onAdd,
    onUpdate,
    onCancel,
    theme,
    savedAreas,
    savedMaterials,
    SelectInput
}) {
    const isEditing = areaIndex !== null;
    const areaData = isEditing ? shift.areas[areaIndex] : null;
    
    const [name, setName] = useState(areaData?.name || '');
    const [description, setDescription] = useState(areaData?.description || '');
    const [startTime, setStartTime] = useState(areaData?.startTime || '');
    const [endTime, setEndTime] = useState(areaData?.endTime || '');
    const [payment, setPayment] = useState(areaData?.payment || '');
    const [materials, setMaterials] = useState(areaData?.materials || [{ name: '', quantity: '', sheets: '' }]);
    const [selectedAreaId, setSelectedAreaId] = useState('');
    const [selectedMaterialId, setSelectedMaterialId] = useState('');
    
    // При выборе сохраненного материала
    useEffect(() => {
        if (selectedMaterialId) {
            console.log('материал ввбран');
            const selectedMaterial = savedMaterials.find(m => m.id === selectedMaterialId);
            if (selectedMaterial) {
                const newMaterials = [...materials];
                newMaterials[newMaterials.length - 1] = {
                    ...newMaterials[newMaterials.length - 1],
                    name: selectedMaterial.name
                };
                setMaterials(newMaterials);
                setSelectedMaterialId('');
            }
        }
    }, [selectedMaterialId, savedMaterials]);

    const handleAreaSelect = (areaName) => {
        const selectedArea = savedAreas.find(area => area.name === areaName);
        if (selectedArea) {
            setName(selectedArea.name);
            setDescription(selectedArea.description || '');
        }
    };
    
    const [totalQuantity, setTotalQuantity] = useState(0);
    const [totalSheets, setTotalSheets] = useState(0);

    const calculateAutoPayment = async () => {
        if (!name) return; // Не выбран участок
        
        try {
            // Находим ID участка по имени
            const area = savedAreas.find(a => a.name === name);
            if (!area) return;
            
            let total = 0;
            let calculatedMaterials = 0;
            
            // Для каждого материала получаем цену и считаем
            for (const material of materials) {
                if (!material.name) continue;
                
                // Находим ID материала по имени
                const materialObj = savedMaterials.find(m => m.name === material.name);
                if (!materialObj) continue;
                
                // Получаем цену для этого материала на участке
                const price = await getMaterialPrice(area.id, materialObj.id);
                if (!price) continue;
                
                // Считаем по количеству
                if (price.pricePerUnit && material.quantity) {
                    total += price.pricePerUnit * parseInt(material.quantity);
                    calculatedMaterials++;
                }
                
                // Считаем по листам
                if (price.pricePerSheet && material.sheets) {
                    total += price.pricePerSheet * parseInt(material.sheets);
                    calculatedMaterials++;
                }
            }
            
            // Если посчитали хотя бы для одного материала - обновляем оплату
            if (calculatedMaterials > 0) {
                setPayment(total.toFixed(2));
            }
        } catch (error) {
            console.error('Ошибка расчета оплаты:', error);
        }
    };

    // Вызываем при изменении материалов или участка
    useEffect(() => {
        calculateAutoPayment();
    }, [materials, name]);

    // Функция для подсчёта итогов
    const calculateTotals = (mats) => {
        let qty = 0;
        let sheets = 0;
        
        mats.forEach(material => {
            qty += parseInt(material.quantity) || 0;
            sheets += parseInt(material.sheets) || 0;
        });
        
        setTotalQuantity(qty);
        setTotalSheets(sheets);
    };

    // Вызываем подсчёт при изменении материалов
    useEffect(() => {
        calculateTotals(materials);
    }, [materials]);

    const handleMaterialChange = (index, field, value) => {
        const newMaterials = [...materials];
        newMaterials[index][field] = value;
        setMaterials(newMaterials);
    };
    
    const addMaterialField = () => {
        setMaterials([...materials, { name: '', quantity: '', sheets: '' }]);
    };
    
    const removeMaterialField = (index) => {
        if (materials.length > 1) {
            const newMaterials = [...materials];
            newMaterials.splice(index, 1);
            setMaterials(newMaterials);
        }
    };
    
    const handleSubmit = (e) => {
        e.preventDefault();
        const area = {
            name,
            description,
            startTime,
            endTime,
            payment,
            materials: materials.filter(m => m.name)
        };
        
        if (isEditing) {
            onUpdate(shiftId, areaIndex, area);
        } else {
            onAdd(shiftId, area);
        }
    };
    
    return (
        <div className="fixed inset-0 dark:bg-black bg-gray-800 dark:bg-opacity-70 bg-opacity-80 flex items-center justify-center p-4 z-50">
            <div className={`${theme === 'dark' ? 'bg-dark-800' : 'bg-light-800'} rounded-xl w-full max-w-md max-h-[90vh] overflow-y-auto shadow-lg`}>
                <div className="p-6">
                    <div className="flex justify-between items-center mb-6">
                        <h2 className="text-xl font-bold">
                            <i className="fas fa-compass mr-2"></i>
                            {isEditing ? 'Редактировать участок' : 'Новый участок'}
                        </h2>
                        <button onClick={onCancel} className="dark:text-gray-500 text-gray-600 hover:dark:text-gray-300 hover:text-gray-800">
                            <i className="fas fa-times"></i>
                        </button>
                    </div>
                    
                    <form onSubmit={handleSubmit}>
                        <div className="space-y-4">
                            {!isEditing && savedAreas.length > 0 ? (
                                <div>
                                    <label className="block text-sm font-medium mb-1">
                                        <i className="fas fa-compass mr-2"></i>
                                        Название участка
                                    </label>
                                    <SelectInput
                                        onChange={(name) => setName(index, name)}
                                        onSelect={handleAreaSelect}
                                        List={savedAreas}
                                        readonly_={true}
                                    />
                                </div>
                            ) : (
                                <div>
                                    <label className="block text-sm font-medium mb-1">
                                        <i className="fas fa-compass mr-2"></i>
                                        Название участка
                                    </label>
                                    <input 
                                        type="text" 
                                        value={name}
                                        onChange={(e) => setName(e.target.value)}
                                        className="w-full dark:bg-dark-700 bg-light-700 border dark:border-dark-600 border-light-500 rounded-lg px-4 py-2 focus:outline-none focus:ring-1 focus:ring-primary-600"
                                        placeholder="Например: Кровельные работы"
                                    />
                                </div>
                            )}
                            
                            <div>
                                <label className="block text-sm font-medium mb-1">
                                    <i className="fas fa-align-left mr-2"></i>
                                    Описание (необязательно)
                                </label>
                                <textarea
                                    value={description}
                                    onChange={(e) => setDescription(e.target.value)}
                                    className="w-full dark:bg-dark-700 bg-light-700 border dark:border-dark-600 border-light-500 rounded-lg px-4 py-2 focus:outline-none focus:ring-1 focus:ring-primary-600"
                                    placeholder="Например: Установка кровли на доме №5"
                                    rows="3"
                                />
                            </div>
                            
                            <div className="grid grid-cols-2 gap-4">
                                <div className="relative">
                                    <label className="block text-sm font-medium mb-1">
                                        <i className="fas fa-clock mr-2"></i>
                                        Начало (ч:мм)
                                    </label>
                                    <input 
                                        type="time" 
                                        value={startTime}
                                        onChange={(e) => setStartTime(e.target.value)}
                                        className="w-full dark:bg-dark-700 bg-light-700 border dark:border-dark-600 border-light-500 rounded-lg px-4 py-2 pl-10 focus:outline-none focus:ring-1 focus:ring-primary-600"
                                        required
                                    />
                                </div>
                                <div className="relative">
                                    <label className="block text-sm font-medium mb-1">
                                        <i className="fas fa-clock mr-2"></i>
                                        Конец (ч:мм)
                                    </label>
                                    <input 
                                        type="time" 
                                        value={endTime}
                                        onChange={(e) => setEndTime(e.target.value)}
                                        className="w-full dark:bg-dark-700 bg-light-700 border dark:border-dark-600 border-light-500 rounded-lg px-4 py-2 pl-10 focus:outline-none focus:ring-1 focus:ring-primary-600"
                                        required
                                    />
                                </div>
                            </div>
                            
                            <div>
                                <label className="block text-sm font-medium mb-1">
                                    <i className="fas fa-money-bill-wave mr-2"></i>
                                    Оплата (₽)
                                </label>
                                <input 
                                    type="number" 
                                    value={payment}
                                    onChange={(e) => {
                                        const tp = e.target.value;
                                        if (tp != 0) {
                                            setPayment(tp);
                                        } else {
                                            setPayment('');
                                        }
                                    }}
                                    className="w-full dark:bg-dark-700 bg-light-700 border dark:border-dark-600 border-light-500 rounded-lg px-4 py-2 focus:outline-none focus:ring-1 focus:ring-primary-600"
                                />
                            </div>
                            
                            <div className="mt-6">
                                <div className="flex justify-between items-center mb-3">
                                    <h3 className="font-medium">
                                        <i className="fas fa-boxes mr-2"></i>
                                        Материалы
                                    </h3>
                                    <button 
                                        type="button"
                                        onClick={addMaterialField}
                                        className="text-primary-600 hover:text-primary-500 text-sm flex items-center"
                                    >
                                        <i className="fas fa-plus mr-1"></i>
                                        Добавить материал
                                    </button>
                                </div>
                                
                                <div className="space-y-4">
                                    {materials.map((material, index) => (
                                        <div key={index} className="relative dark:bg-dark-700 bg-light-700 p-4 rounded-lg border dark:border-dark-600 border-light-500">
                                            <div className="space-y-3">
                                                <div>
                                                    <label className="block text-xs font-medium mb-1 dark:text-gray-400 text-gray-600">
                                                        Название материала
                                                    </label>
                                                    {savedMaterials.length > 0 ? (
                                                            <SelectInput
                                                                value={material.name}
                                                                onChange={(e) => handleMaterialChange(index, 'name', e.target.value)}
                                                                onSelect={(name) => handleMaterialChange(index, 'name', name)}
                                                                List={savedMaterials}
                                                            />
                                                    ) : (
                                                        <input 
                                                            type="text" 
                                                            value={material.name}
                                                            onChange={(e) => handleMaterialChange(index, 'name', e.target.value)}
                                                            className="w-full dark:bg-dark-600 bg-light-600 border dark:border-dark-500 border-light-400 rounded-lg px-3 py-2 text-sm focus:outline-none focus:ring-1 focus:ring-primary-600"
                                                            placeholder="Название"
                                                        />
                                                    )}
                                                </div>
                                                <div className="grid grid-cols-2 gap-3">
                                                    <div>
                                                        <label className="block text-xs font-medium mb-1 dark:text-gray-400 text-gray-600">
                                                            Количество
                                                        </label>
                                                        <input 
                                                            type="text" 
                                                            value={material.quantity}
                                                            onChange={(e) => handleMaterialChange(index, 'quantity', e.target.value)}
                                                            className="w-full dark:bg-dark-600 bg-light-600 border dark:border-dark-500 border-light-400 rounded-lg px-3 py-2 text-sm focus:outline-none focus:ring-1 focus:ring-primary-600"
                                                            placeholder="Кол-во"
                                                        />
                                                    </div>
                                                    <div>
                                                        <label className="block text-xs font-medium mb-1 dark:text-gray-400 text-gray-600">
                                                            Листы
                                                        </label>
                                                        <input 
                                                            type="text" 
                                                            value={material.sheets}
                                                            onChange={(e) => handleMaterialChange(index, 'sheets', e.target.value)}
                                                            className="w-full dark:bg-dark-600 bg-light-600 border dark:border-dark-500 border-light-400 rounded-lg px-3 py-2 text-sm focus:outline-none focus:ring-1 focus:ring-primary-600"
                                                            placeholder="Листы"
                                                        />
                                                    </div>
                                                </div>
                                            </div>
                                            {materials.length > 1 && (
                                                <button 
                                                    type="button"
                                                    onClick={() => removeMaterialField(index)}
                                                    className="absolute top-2 right-2 text-gray-500 hover:text-red-500"
                                                >
                                                    <i className="fas fa-times"></i>
                                                </button>
                                            )}
                                        </div>
                                    ))}
                                </div>
                            </div>
                            
                            <div className="mt-4 dark:bg-dark-700 bg-light-700 p-3 rounded-lg">
                                <div className="flex justify-between">
                                    <span className="font-medium">Итого:</span>
                                    <div className="flex gap-4">
                                        <span>
                                            <span className="dark:text-gray-400 text-gray-600">Кол-во: </span>
                                            <span className="font-bold">{totalQuantity}</span>
                                        </span>
                                        <span>
                                            <span className="dark:text-gray-400 text-gray-600">Листы: </span>
                                            <span className="font-bold">{totalSheets}</span>
                                        </span>
                                    </div>
                                </div>
                            </div>

                            <div className="flex gap-3 pt-6">
                                <button
                                    type="button"
                                    onClick={onCancel}
                                    className="flex-1 dark:bg-dark-600 bg-light-600 hover:dark:bg-dark-600 hover:bg-light-600 py-3 rounded-lg flex items-center justify-center"
                                >
                                    <i className="fas fa-times mr-2"></i>
                                    Отмена
                                </button>
                                <button
                                    type="submit"
                                    className="flex-1 bg-primary-600 hover:bg-primary-700 py-3 rounded-lg flex items-center justify-center text-white"
                                >
                                    <i className="fas fa-check mr-2"></i>
                                    Сохранить
                                </button>
                            </div>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    );
}
        
        const calculateWorkHours = (startTime, endTime, lunchStart, lunchEnd) => {
            if (!startTime || !endTime) return 0;
            
            const start = new Date(`2000-01-01T${startTime}`);
            const end = new Date(`2000-01-01T${endTime}`);
            const lunchS = new Date(`2000-01-01T${lunchStart}`);
            const lunchE = new Date(`2000-01-01T${lunchEnd}`);
            
            // Корректировка если смена переходит через полночь
            if (end < start) end.setDate(end.getDate() + 1);
            if (lunchE < lunchS) lunchE.setDate(lunchE.getDate() + 1);
            
            let totalMs = end - start;
            
            // Проверяем полностью ли охватывается обеденное время
            if (start <= lunchS && end >= lunchE) {
                const lunchDuration = lunchE - lunchS;
                totalMs -= Math.max(0, lunchDuration);
            }
            
            return (totalMs / (1000 * 60 * 60)).toFixed(2);
        };
        
        // Рендерим приложение
        const root = createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>
