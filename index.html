<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <meta name="theme-color" content="#a16ff7">
  <title>Мои смены</title>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  <script src="https://cdn.tailwindcss.com"></script>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
  <style>
    :root {
      --accent-color: #a16ff7;
      --accent-light: #c5a8ff;
      --accent-dark: #7d4fd6;
      --accent-10: rgba(161, 111, 247, 0.1);
      --accent-20: rgba(161, 111, 247, 0.2);
    }
    body {
      font-family: 'Inter', sans-serif;
      margin: 0;
      padding: 0;
      background: #f8fafc;
      color: #1e293b;
      overflow-x: hidden;
    }
    #root {
      padding: 20px;
      min-height: 100vh;
      box-sizing: border-box;
      position: relative;
    }
    h1 {
      font-size: 1.75rem;
      font-weight: 700;
      color: #1e293b;
      text-align: center;
      margin-bottom: 20px;
      margin-bottom: 30px; /* Добавлен отступ снизу для заголовка */
      font-weight: bold; /* Сделан жирным */
    }
    .tasks-container {
      display: flex;
      flex-direction: column;
      gap: 16px;
      background: #f8fafc;
      border-radius: 12px;
      padding-bottom: 60px;
    }
    .task-card {
      background: #ffffff;
      border-radius: 8px;
      padding: 16px;
      display: flex;
      flex-direction: column;
      gap: 8px;
      transition: transform 0.2s, box-shadow 0.2s;
      box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
    }
    .task-card:hover {
      transform: translateY(-2px);
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
    }
    .task-field {
      display: flex;
      justify-content: space-between;
      font-size: 0.9rem;
      color: #1e293b;
    }
    .task-field.materials_ {
      display: flex;
      flex-direction: column;
      max-width: 100%;
      font-size: 0.9rem;
      color: #1e293b;
    }
    .task-field-label {
      font-weight: 600;
      color: #64748b;
    }
    .task-field-value {
      color: #1e293b;
      /* max-width: 60%; */
      word-wrap: break-word;
    }
    .material-list {
      list-style: none;
      padding: 0;
      padding-top: 8px;
      /* padding-bottom: 8px; */
      /* gap: 8px; */
      margin: 0;
      display: flex;
      flex-direction: column;
      max-width: 100%;
    }
    .material-item {
      display: flex;
      align-items: center;
      gap: 8px;
      padding: 8px 12px;
      background: #f1f5f9;
      border-left: 4px solid var(--accent-color);
      border-radius: 6px;
      font-size: 0.9rem;
      color: #1e293b;
      /* transition: background-color 0.2s; */
      margin-bottom: 8px;
    }
    .nopay-item {
      display: flex;
      align-items: center;
      gap: 8px;
      padding: 8px 12px;
      background: transparent;
      background: #fff;
      border-radius: 6px;
      font-size: 0.9rem;
      color: #1e293b;
      margin-bottom: 8px;
      border: 1px solid #ccc;
      /* box-shadow: 0 0 5px rgba(0, 0, 0, 0.20); */
    }
    /* .material-item:hover { */
    /*   background: #e2e8f0; */
    /* } */
    .material-item svg {
      width: 18px;
      height: 18px;
      color: var(--accent-color);
      flex-shrink: 0;
    }
    .material-text {
      display: flex;
      justify-content: space-between;
      align-items: center;
      width: 100%;
      overflow-wrap: break-word;
      word-wrap: break-word;
    }
    .material-name {
      font-weight: 500;
      color: #1e293b;
    }
    .material-count {
      background: var(--accent-10);
      color: var(--accent-color);
      padding: 2px 8px;
      border-radius: 12px;
      font-size: 0.85rem;
      font-weight: 600;
    }
    .action-buttons {
      display: flex;
      flex-wrap: wrap;
      gap: 8px;
      margin-top: 12px;
    }
    .modal {
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0, 0, 0, 0.3);
      display: flex;
      justify-content: center;
      align-items: center;
      z-index: 1200;
      animation: fadeIn 0.3s ease;
    }
    .modal-content {
      background: #ffffff;
      padding: 24px;
      border-radius: 12px;
      width: 90%;
      /* max-width: 500px; */
      /* max-height: 80vh; */
      overflow-y: auto;
      box-shadow: 0 6px 16px rgba(0, 0, 0, 0.1);
      position: relative;
      padding-bottom: 70px;
    }
    .modal-content h2 {
      color: #1e293b;
    }
    .close-button {
      position: absolute;
      top: 16px;
      right: 16px;
      background: none;
      border: none;
      font-size: 1.5rem;
      color: #64748b;
      cursor: pointer;
      transition: color 0.2s;
      padding: 8px 12px;
      min-height: 48px;
    }
    .close-button:hover {
      color: #1e293b;
    }
    .add-button {
      position: fixed;
      bottom: 100px;
      right: 24px;
      width: 64px;
      height: 64px;
      border-radius: 50%;
      background: var(--accent-color);
      color: white;
      display: flex;
      align-items: center;
      justify-content: center;
      box-shadow: 0 0 12px var(--accent-color);
      transition: transform 1s ease, background-color 0.3s;
      padding: 12px;
      font-size: 1rem;
      z-index: 1100;
    }
    .add-button:active {
      transform: scale(2);
      transition: transform 1s ease;
      background: var(--accent-dark);
    }
    .action-button {
      padding: 12px 20px;
      border-radius: 8px;
      transition: background-color 0.2s, transform 0.2s;
      color: white;
      font-size: 1rem;
      font-weight: 700;
      cursor: pointer;
      min-height: 48px;
    }
    .edit-button {
      background: #10b981;
      flex: 1;
    }
    /* .edit-button:hover { */
    /*   background: #059669; */
    /*   transform: translateY(-1px); */
    /* } */
    .delete-button {
      background: #ef4444;
      flex: 1;
      text-align: center;
    }
    .confirm-delete {
  background-color: #ef4444;
  animation: pulse 1.5s infinite;
}

@keyframes pulse {
  0% {
    box-shadow: 0 0 0 0 rgba(239, 68, 68, 0.7);
  }
  70% {
    box-shadow: 0 0 0 10px rgba(239, 68, 68, 0);
  }
  100% {
    box-shadow: 0 0 0 0 rgba(239, 68, 68, 0);
  }
}
    /* .delete-button:hover { */
    /*   background: #dc2626; */
    /*   transform: translateY(-1px); */
    /* } */
    .form-input,
    .form-textarea,
    .form-select {
      background: #f8fafc;
      border: 1px solid #e2e8f0;
      padding: 10px;
      border-radius: 6px;
      color: #1e293b;
      width: 100%;
      margin-bottom: 12px;
      transition: border-color 0.2s, box-shadow 0.2s;
      font-size: 0.9rem;
      box-sizing: border-box;
      font-family: 'Inter', sans-serif;
    }
    .form-textarea {
      min-height: 150px;
      resize: vertical;
    }
    .form-input:focus,
    .form-textarea:focus,
    .form-select:focus {
      outline: none;
      border-color: #a16ff7;
      box-shadow: 0 0 0 3px var(--accent-10);
    }
    .form-label {
      display: block;
      font-size: 0.9rem;
      color: #64748b;
      margin-bottom: 6px;
      font-weight: 500;
    }
    .material-row {
      display: flex;
      flex-direction: column;
      gap: 12px;
      margin-bottom: 12px;
    }
    .material-input {
      width: 100%;
    }
    .material-add-button {
      width: 100%;
      box-sizing: border-box;
      padding: 10px 16px;
      border-radius: 8px;
      background: #10b981;
      color: white;
      font-weight: 500;
      transition: background-color 0.2s, transform 0.2s;
      font-size: 0.9rem;
      min-height: 48px;
      margin-bottom: 12px;
      border: none;
      cursor: pointer;
    }
    /* .material-add-button:hover { */
    /*   background: #059669; */
    /*   transform: translateY(-1px); */
    /* } */
    .material-remove-button {
      padding: 8px 12px;
      border-radius: 8px;
      background: #ef4444;
      color: white;
      font-weight: 500;
      transition: background-color 0.2s, transform 0.2s;
      font-size: 0.9rem;
      border: none;
      cursor: pointer;
    }
    /* .material-remove-button:hover { */
    /*   background: #dc2626; */
    /*   transform: translateY(-1px); */
    /* } */
    .submit-button {
      display: flex;
      align-items: center;
      gap: 8px;
      padding: 12px 20px;
      border-radius: 8px;
      background: var(--accent-color);
      color: white;
      font-weight: 500;
      transition: background-color 0.2s, transform 0.2s;
      font-size: 1rem;
      min-height: 48px;
      border: none;
      cursor: pointer;
    }
    /* .submit-button:hover { */
    /*   background: var(--accent-dark); */
    /*   transform: translateY(-1px); */
    /* } */
    .submit-button svg {
      width: 18px;
      height: 18px;
    }
    .clear-button {
      display: flex;
      align-items: center;
      gap: 8px;
      padding: 12px 20px;
      border-radius: 8px;
      background: #6b7280;
      color: white;
      font-weight: 500;
      transition: background-color 0.2s, transform 0.2s;
      font-size: 1rem;
      min-height: 48px;
      border: none;
      cursor: pointer;
    }
    .clear-button:hover {
      background: #4b5563;
      transform: translateY(-1px);
    }
    .clear-button svg {
      width: 18px;
      height: 18px;
    }
    .nav-bar {
      position: fixed;
      bottom: 0;
      left: 0;
      width: 96%;
      /* background: #ffffff; */
      background: rgba(255, 255, 255, 0.1);
      box-shadow: 0 0 8px rgba(0, 0, 0, 0.10);
      display: flex;
      justify-content: space-around;
      padding: 15px 0;
      z-index: 1200;
      border-radius: 15px;
      margin-bottom: 10px;
      margin-left: 8px;
      margin-right: 5px;
      backdrop-filter: blur(15px);
    }
    .nav-item {
      display: flex;
      flex-direction: column;
      align-items: center;
      color: #64748b;
      text-decoration: none;
      font-size: 0.75rem;
      transition: color 0.6s;
    }
    .nav-item svg {
      width: 20px;
      height: 20px;
      margin-bottom: 4px;
    }
    .nav-item.active {
      color: var(--accent-color);
      font-weight: bold;
      transform: scale(1.1) translate(0, -7%);
      transition: transform 0.3s;
    }
    .stats-container, .settings-container {
      background: #ffffff;
      border-radius: 12px;
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.05);
      padding: 20px;
      padding-bottom: 60px;
    }
    .material-stats {
      margin-top: 20px;
    }
    .material-stats-table {
      width: 100%;
      border-collapse: collapse;
      margin-top: 12px;
    }
    .material-stats-table th,
    .material-stats-table td {
      padding: 8px;
      text-align: left;
      border-bottom: 1px solid #e2e8f0;
      font-size: 0.9rem;
    }
    .material-stats-table th {
      background: #f1f5f9;
      font-weight: 600;
      color: #64748b;
    }
    .material-stats-table td {
      color: #1e293b;
    }
    .chart-container {
      margin-top: 20px;
      /* padding: 16px; */
      background: #ffffff;
      border-radius: 12px;
      box-shadow: 0 0 4px rgba(0, 0, 0, 0.1);
    }
    .chart-canvas {
      min-height: 300px;
      width: 100%;
    }
    .settings-buttons {
      display: flex;
      flex-direction: column;
      gap: 12px;
      margin-top: 12px;
    }
    .settings-buttons .submit-button,
    .settings-buttons .clear-button {
      width: 100%;
    }
    .material-mode-toggle {
      display: flex;
      gap: 16px;
      margin-bottom: 12px;
    }
    .material-mode-toggle label {
      display: flex;
      align-items: center;
      gap: 8px;
      font-size: 0.9rem;
      color: #64748b;
      cursor: pointer;
    }
    /* Полный сброс стандартных стилей */
input[type="radio"] {
  -webkit-appearance: none;
  -moz-appearance: none;
  appearance: none;
  margin: 0;
  padding: 0;
  width: 16px;
  height: 16px;
  border: 1.5px solid #ccc; /* Цвет границы в невыбранном состоянии */
  border-radius: 50%;
  background: white; /* Фон всегда белый */
  cursor: pointer;
  position: relative;
  transition: border-color 0.2s ease;
}

/* Состояние выбранной кнопки */
input[type="radio"]:checked {
  border-color: var(--accent-color); /* Цвет границы при выборе */
  background: white; /* Явно задаем белый фон */
}

/* Внутренний кружок (индикатор выбора) */
input[type="radio"]:checked::before {
  content: '';
  position: absolute;
  top: 50%;
  left: 50%;
  transform: translate(-50%, -50%);
  width: 8px;
  height: 8px;
  background: var(--accent-color); /* Цвет только для внутреннего кружка */
  border-radius: 50%;
}

/* Состояние при фокусе */
/* input[type="radio"]:focus { */
/*   outline: none; */
/*   box-shadow: 0 0 0 3px rgba(161, 111, 247, 0.3); */
/* } */
    .filter-container {
      background: #ffffff;
      border-radius: 12px;
      box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
      padding: 16px;
      margin-bottom: 16px;
      display: flex;
      flex-direction: column;
      gap: 12px;
    }
    .filter-row {
      display: flex;
      flex-wrap: wrap;
      gap: 12px;
      align-items: center;
    }
    .sort-button {
      padding: 8px 16px;
      border-radius: 8px;
      background: #6b7280;
      color: white;
      font-weight: 500;
      transition: background-color 0.2s, transform 0.2s;
      font-size: 0.9rem;
      border: none;
      cursor: pointer;
    }
    .sort-button:hover {
      background: #4b5563;
      transform: translateY(-1px);
    }
    .reset-button {
      padding: 8px 16px;
      border-radius: 8px;
      background: #ef4444;
      color: white;
      font-weight: 500;
      transition: background-color 0.2s, transform 0.2s;
      font-size: 0.9rem;
      border: none;
      cursor: pointer;
    }
    .reset-button:hover {
      background: #dc2626;
      transform: translateY(-1px);
    }
    @media (max-width: 768px) {
      .task-card {
        padding: 12px;
        font-size: 0.85rem;
      }
      .modal-content {
        max-width: 500px;
        max-height: 80vh;
      }
      .nav-bar {
        width: 96%;
        margin-bottom: 10px;
      }
      .task-field {
        font-size: 0.85rem;
      }
      .task-field.description {
          display: flex;
          flex-direction: column;
      }
      .task-field-value.description {
          display: flex;
          padding-top: 8px;
          justify-content: center;
      }
      .task-field-value {
        max-width: 100%;
      }
      
      .action-button {
        padding: 10px 16px;
        font-size: 0.9rem;
      }
      .modal-content {
        width: 95%;
        padding: 16px;
        padding-bottom: 70px;
      }
      .form-input,
      .form-textarea,
      .form-select {
        font-size: 0.9rem;
      }
      .add-button {
        bottom: 100px;
        right: 16px;
        width: 56px;
        height: 56px;
      }
      .submit-button,
      .clear-button {
        padding: 10px 16px;
        font-size: 0.9rem;
      }
      .nav-item {
        font-size: 0.7rem;
        font-weight: bold;
      }
      .nav-item svg {
        width: 18px;
        height: 18px;
      }
      .material-stats-table th,
      .material-stats-table td {
        font-size: 0.8rem;
        padding: 6px;
      }
      .material-item {
        font-size: 0.85rem;
        padding: 6px 10px;
      }
      .material-item svg {
        width: 16px;
        height: 16px;
      }
      .material-count {
        font-size: 0.8rem;
        padding: 1px 6px;
      }
      .material-mode-toggle label {
        font-size: 0.85rem;
      }
      .filter-row {
        flex-direction: column;
        gap: 8px;
      }
      .sort-button,
      .reset-button {
        width: 100%;
        font-size: 0.85rem;
      }
    }
    #error-message {
      color: #ef4444;
      padding: 20px;
      text-align: center;
      font-size: 1rem;
    }
  </style>
  <style>
/* выбрать элемент */
.relative {
  position: relative;
}
.absolute {
  position: absolute;
}
.z-10 {
  z-index: 10;
}
.max-h-60 {
  max-height: 15rem;
}
.overflow-y-auto {
  overflow-y: auto;
}
.rounded-r-none {
  border-top-right-radius: 0;
  border-bottom-right-radius: 0;
}
.rounded-r-md {
  border-top-right-radius: 0.375rem;
  border-bottom-right-radius: 0.375rem;
}
  </style>
  <style>
  .dropdown {
  /* position: relative; */
  display: flex;
  flex-direction: column;
  font-family: Arial, sans-serif;
}

.dropdown-toggle {
  width: 100%;
  padding: 10px 15px;
  background: #f0f0f0;
  border: 1px solid #ccc;
  border-radius: 4px;
  cursor: pointer;
  text-align: left;
  font-size: 16px;
}

.dropdown-toggle:hover {
  background-color: #e5e5e5;
}

.dropdown-menu {
  /* position: absolute; */
  top: 100%;
  left: 0;
  width: 100%;
  margin-bottom: 5px;
  padding: 0;
  list-style: none;
  background: white;
  border: 1px solid #ddd;
  border-radius: 4px;
  box-shadow: 0 2px 10px rgba(0,0,0,0.1);
  /* z-index: 100; */
  /* max-height: 300px; */
  overflow-y: auto;
}

.dropdown-item {
  display: flex;
  justify-content: space-between;
  align-items: center;
  padding: 10px 15px;
  border-bottom: 1px solid #eee;
}

.dropdown-item:last-child {
  border-bottom: none;
}
  </style>
  <style>
  .pie-chart-container {
    margin-top: 30px;
    padding: 16px;
    background: #ffffff;
    border-radius: 12px;
    box-shadow: 0 0 4px rgba(0, 0, 0, 0.1);
    height: 400px;
  }
</style>
<style>
  .scroll-to-top {
  position: fixed;
  bottom: 180px;
  right: 24px;
  width: 64px;
  height: 64px;
  border-radius: 50%;
  background: #6b7280;
  color: white;
  display: flex;
  align-items: center;
  justify-content: center;
  box-shadow: 0 4px 12px rgba(107, 114, 128, 0.3);
  transition: transform 0.2s ease, background-color 0.3s;
  padding: 12px;
  font-size: 1rem;
  z-index: 1100;
}
.scroll-to-top:focus {
  transform: scale(1.1);
  background: #4b5563;
}
</style>
</head>
<body>
  <div id="root"></div>
  <div id="error-message" style="display: none;"></div>

  <script>
    const dependencies = [
      { src: 'https://cdn.jsdelivr.net/npm/react@18.3.1/umd/react.production.min.js', global: 'React' },
      { src: 'https://cdn.jsdelivr.net/npm/react-dom@18.3.1/umd/react-dom.production.min.js', global: 'ReactDOM' },
      { src: 'https://cdn.jsdelivr.net/npm/@babel/standalone@7.25.7/babel.min.js', global: 'Babel' },
      { src: 'https://cdn.jsdelivr.net/npm/chart.js@4.4.3/dist/chart.umd.min.js', global: 'Chart' }
    ];

    let loadedDependencies = 0;

    function loadDependency(index) {
      if (index >= dependencies.length) {
        console.log('Все зависимости загружены, запуск приложения...');
        loadApplication();
        return;
      }

      const { src, global } = dependencies[index];
      const script = document.createElement('script');
      script.src = src;
      script.async = true;
      script.crossOrigin = 'anonymous';
      script.onload = () => {
        console.log(`${global} успешно загружен.`);
        loadedDependencies++;
        loadDependency(index + 1);
      };
      script.onerror = () => {
        console.error(`Ошибка загрузки ${global} из ${src}.`);
        const errorMessage = document.getElementById('error-message');
        errorMessage.style.display = 'block';
        errorMessage.textContent = `Ошибка: Не удалось загрузить ${global}. Проверьте подключение к интернету или консоль.`;
      };
      document.head.appendChild(script);
    }

    function loadApplication() {
      try {
        console.log('Проверка зависимостей...');
        if (!window.React || !window.ReactDOM || !window.Babel || !window.Chart) {
          throw new Error('Одна или несколько зависимостей не загружены: ' + 
            `React: ${!!window.React}, ReactDOM: ${!!window.ReactDOM}, Babel: ${!!window.Babel}, Chart: ${!!window.Chart}`);
        }
        if (!document.getElementById('root')) {
          throw new Error('Элемент #root не найден в DOM.');
        }

        console.log('Трансформация JSX-кода...');
        const jsxCode = document.getElementById('jsx-code').textContent;
        let transformedCode;
        try {
          transformedCode = Babel.transform(jsxCode, { 
            presets: ['env', 'react'],
            filename: 'index.js'
          }).code;
          console.log('JSX успешно преобразован, длина кода:', transformedCode.length);
        } catch (babelError) {
          throw new Error('Ошибка трансформации JSX: ' + babelError.message);
        }

        console.log('Выполнение преобразованного кода...');
        const script = document.createElement('script');
        script.textContent = transformedCode;
        document.body.appendChild(script);
        console.log('Преобразованный код добавлен в DOM.');
      } catch (error) {
        console.error('Ошибка при выполнении приложения:', error);
        const errorMessage = document.getElementById('error-message');
        errorMessage.style.display = 'block';
        errorMessage.textContent = `Произошла ошибка: ${error.message}. Проверьте консоль для подробностей.`;
      }
    }

    console.log('Начало загрузки зависимостей...');
    loadDependency(0);
  </script>

  <script id="jsx-code" type="text/babel">
    const { useState, useEffect, useRef, useCallback } = React;
    const { createRoot } = ReactDOM;

    const initialTasks = [];

    const initialSections = [];
    const initialMaterials = [];

    function App() {

      const round = (num, decimalPlaces) => {
    const factor = Math.pow(10, decimalPlaces);
    return Math.trunc(num * factor) / factor;
};

      const scrollToTop = () => {
  window.scrollTo({
    top: 760,
    behavior: 'smooth'
  });
};

const [accentColor, setAccentColor] = useState(() => {
  const savedColor = localStorage.getItem('accentColor');
  return savedColor || '#a16ff7';
});

// Функция для преобразования HEX в RGB
const hexToRgb = (hex) => {
  // Удаляем # если есть
  hex = hex.replace('#', '');
  
  // Если короткая запись цвета (например, #abc), расширяем до полной (#aabbcc)
  if (hex.length === 3) {
    hex = hex.split('').map(c => c + c).join('');
  }
  
  // Преобразуем в RGB
  const r = parseInt(hex.substring(0, 2), 16);
  const g = parseInt(hex.substring(2, 4), 16);
  const b = parseInt(hex.substring(4, 6), 16);
  
  return { r, g, b };
};

// Функция для преобразования RGB в HEX
const rgbToHex = (r, g, b) => {
  const toHex = (c) => {
    const hex = c.toString(16);
    return hex.length === 1 ? '0' + hex : hex;
  };
  
  return `#${toHex(r)}${toHex(g)}${toHex(b)}`;
};

// Функция для осветления цвета (amount от 0 до 1)
const lightenColor = (hex, amount) => {
  const { r, g, b } = hexToRgb(hex);
  
  const newR = Math.min(255, r + Math.round(255 * amount));
  const newG = Math.min(255, g + Math.round(255 * amount));
  const newB = Math.min(255, b + Math.round(255 * amount));
  
  return rgbToHex(newR, newG, newB);
};

// Функция для затемнения цвета (amount от 0 до 1)
const darkenColor = (hex, amount) => {
  const { r, g, b } = hexToRgb(hex);
  
  const newR = Math.max(0, r - Math.round(255 * amount));
  const newG = Math.max(0, g - Math.round(255 * amount));
  const newB = Math.max(0, b - Math.round(255 * amount));
  
  return rgbToHex(newR, newG, newB);
};

const updateAccentColors = (color) => {
  // Преобразуем HEX в RGB для полупрозрачных вариантов
  const rgb = hexToRgb(color);
  const rgbString = `${rgb.r}, ${rgb.g}, ${rgb.b}`;
  
  // Обновляем CSS-переменные
  document.documentElement.style.setProperty('--accent-color', color);
  document.documentElement.style.setProperty('--accent-light', lightenColor(color, 0.2));
  document.documentElement.style.setProperty('--accent-dark', darkenColor(color, 0.2));
  document.documentElement.style.setProperty('--accent-10', `rgba(${rgbString}, 0.1)`);
  document.documentElement.style.setProperty('--accent-20', `rgba(${rgbString}, 0.2)`);
  
  // Обновляем theme-color meta tag
  const metaThemeColor = document.querySelector("meta[name=theme-color]");
  if (metaThemeColor) {
    metaThemeColor.setAttribute("content", color);
  }
};


useEffect(() => {
  localStorage.setItem('accentColor', accentColor);
  updateAccentColors(accentColor);
}, [accentColor]);

// Инициализация при загрузке
useEffect(() => {
  updateAccentColors(accentColor);
}, []);


      const [tasks, setTasks] = useState(() => {
        try {
          const savedTasks = localStorage.getItem('tasks');
          console.log('Данные из localStorage (tasks):', savedTasks ? JSON.parse(savedTasks).slice(0, 2) : 'Отсутствуют');
          if (!savedTasks) {
            console.log('Используются начальные задачи.');
            return initialTasks.map(task => ({ ...task, id: task.id || Date.now() + Math.random() }));
          }
          const parsedTasks = JSON.parse(savedTasks);
          if (!Array.isArray(parsedTasks)) {
            console.warn('Данные в localStorage не являются массивом, возвращены начальные задачи.');
            return initialTasks.map(task => ({ ...task, id: task.id || Date.now() + Math.random() }));
          }
          console.log('Загружено', parsedTasks.length, 'задач из localStorage.');
          return parsedTasks.map(task => ({
            ...task,
            id: task.id || Date.now() + Math.random(),
            materials: task.materials && Array.isArray(task.materials) ? task.materials : task.material ? [{ material: task.material, count: task.count || 0 }] : []
          }));
        } catch (e) {
          console.error('Ошибка при загрузке задач из localStorage:', e);
          return initialTasks.map(task => ({ ...task, id: task.id || Date.now() + Math.random() }));
        }
      });
      const [sections, setSections] = useState(() => {
        try {
          const savedSections = localStorage.getItem('sections');
          console.log('Данные из localStorage (sections):', savedSections ? JSON.parse(savedSections) : 'Отсутствуют');
          if (!savedSections) return initialSections;
          const parsedSections = JSON.parse(savedSections);
          return Array.isArray(parsedSections) ? parsedSections.map(s => typeof s === 'string' ? s : s.name || '') : initialSections;
        } catch (e) {
          console.error('Ошибка при загрузке участков из localStorage:', e);
          return initialSections;
        }
      });
      const [materials, setMaterials] = useState(() => {
        try {
          const savedMaterials = localStorage.getItem('materials');
          console.log('Данные из localStorage (materials):', savedMaterials ? JSON.parse(savedMaterials) : 'Отсутствуют');
          if (!savedMaterials) return initialMaterials;
          const parsedMaterials = JSON.parse(savedMaterials);
          return Array.isArray(parsedMaterials) ? parsedMaterials.map(m => typeof m === 'string' ? m : m.name || '') : initialMaterials;
        } catch (e) {
          console.error('Ошибка при загрузке материалов из localStorage:', e);
          return initialMaterials;
        }
      });
      const [activeTab, setActiveTab] = useState('tasks');
      const [showModal, setShowModal] = useState(false);
      const [editingTask, setEditingTask] = useState(null);
      const [sortOrder, setSortOrder] = useState(() => {
        const savedSortOrder = localStorage.getItem('sortOrder');
        return savedSortOrder ? savedSortOrder : 'ascending';
      });
      const [formData, setFormData] = useState({
        date: '',
        section: '',
        description: '',
        material: '',
        count: '',
        start_time: '08:00',
        end_time: '17:00',
        payment: '',
        materials: [{ material: '', count: '', materialInputMode: 'select' }],
        all_count: '',
        newMaterial: '',
        newSection: ''
      });
      const chartRef = useRef(null);
      const chartInstanceRef = useRef(null);
      const [showMaterialSuggestions, setShowMaterialSuggestions] = useState(false);

      const DeleteButton = ({ classes, onDelete }) => {
  const [isConfirming, setIsConfirming] = useState(false);
  const buttonRef = useRef(null);

  useEffect(() => {
    const handleClickOutside = (e) => {
      if (buttonRef.current && !buttonRef.current.contains(e.target)) {
        setIsConfirming(false);
      }
    };

    document.addEventListener('click', handleClickOutside);
    return () => document.removeEventListener('click', handleClickOutside);
  }, []);

  const handleClick = () => {
    if (isConfirming) {
      onDelete();
    } else {
      setIsConfirming(true);
    }
  };

  return (
    <button
      ref={buttonRef}
      onClick={handleClick}
      className={`${classes} ${isConfirming ? 'confirm-delete' : ''}`}
    >
      {isConfirming ? 'Удалить?' : 'Удалить'}
    </button>
  );
};

      const formatDateToInput = (dateStr) => {
        if (!dateStr) return '';
        try {
          const [day, month] = dateStr.split(' ');
          const monthIndex = [
            'января',
            'февраля',
            'марта',
            'апреля',
            'мая',
            'июня',
            'июля',
            'августа',
            'сентября',
            'октября',
            'ноября',
            'декабря'
          ].indexOf(month.toLowerCase());
          if (monthIndex === -1) return '';
          const year = new Date().getFullYear();
          const monthNum = String(monthIndex + 1).padStart(2, '0');
          const dayNum = String(parseInt(day)).padStart(2, '0');
          return `${year}-${monthNum}-${dayNum}`;
        } catch (e) {
          console.error('Ошибка при преобразовании даты в формат input:', dateStr, e);
          return '';
        }
      };

      const formatDateToDisplay = (dateStr) => {
        if (!dateStr) return 'Не указана';
        try {
          const date = new Date(dateStr);
          if (isNaN(date.getTime())) return 'Не указана';
          const day = date.getDate();
          const monthIndex = date.getMonth();
          const months = ['января', 'февраля', 'марта', 'апреля', 'мая', 'июня', 'июля', 'августа', 'сентября', 'октября', 'ноября', 'декабря'];
          return `${day} ${months[monthIndex]}`;
        } catch (e) {
          console.error('Ошибка при преобразовании даты в формат отображения:', dateStr, e);
          return 'Не указана';
        }
      };

      const updateMaterialsFromTasks = (tasksToScan) => {
        const allMaterials = new Set(materials);
        tasksToScan.forEach(task => {
          if (task.material) {
            allMaterials.add(task.material);
          }
          if (task.materials && Array.isArray(task.materials)) {
            task.materials.forEach(mat => {
              if (mat.material) {
                allMaterials.add(mat.material);
              }
            });
          }
        });
        const updatedMaterials = Array.from(allMaterials);
        setMaterials(updatedMaterials);
        console.log('Обновлен список материалов:', updatedMaterials);
      };

      useEffect(() => {
        updateMaterialsFromTasks(tasks);
      }, [tasks]);

      
    const buildChart = () => {
  if (!chartRef.current || activeTab !== 'stats') return;

  try {
    // Уничтожаем предыдущий график, если он существует
    if (chartInstanceRef.current) {
      chartInstanceRef.current.destroy();
    }

    // Фильтруем задачи по выбранному диапазону дат
    const paymentByDate = tasks
      .filter(task => {
        if (!task.date || !task.payment) return false;
        const taskDateStr = formatDateToInput(task.date);
        if (!taskDateStr) return false;
        const taskDate = new Date(taskDateStr);
        const start = new Date(dateRange.start);
        const end = new Date(dateRange.end);
        return taskDate >= start && taskDate <= end;
      })
      .map(task => ({
        date: task.date,
        section: task.section,
        payment: Number(task.payment) || 0,
        taskDate: new Date(formatDateToInput(task.date))
      }))
      .sort((a, b) => a.taskDate - b.taskDate);

    if (paymentByDate.length === 0) {
      // console.log('Нет данных для построения графика в выбранном диапазоне.');
      const ctx = chartRef.current.getContext('2d');
      ctx.font = '14px Inter';
      ctx.fillStyle = '#64748b';
      ctx.textAlign = 'center';
      ctx.fillText('Нет данных', chartRef.current.width / 2, chartRef.current.height / 2);
      return;
    }

    const labels = paymentByDate.map(item => item.date + ` (${item.section})`);
    const data = paymentByDate.map(item => item.payment);

    const rgb = hexToRgb(accentColor);

    const ctx = chartRef.current.getContext('2d');
    chartInstanceRef.current = new Chart(ctx, {
      // type: 'line',
      type: 'bar',
      data: {
        labels: labels,
        datasets: [
            {
              data: data,
              borderColor: accentColor,
              borderRadius: 1.5,
              backgroundColor: `rgba(${rgb.r}, ${rgb.g}, ${rgb.b}, 0.5)`,
              fill: true
            }
        ]
      },
      options: {
        responsive: true,
        maintainAspectRatio: false,
        scales: {
          x: {
            display: true,
            title: {
              display: true,
              text: 'Дата',
              font: { size: 14 },
              color: '#64748b'
            },
            ticks: {
              font: { size: 12 },
              color: '#64748b'
            }
          },
          y: {
            display: true,
            title: {
              display: true,
              text: 'Оплата',
              font: { size: 14 },
              color: '#64748b'
            },
            ticks: {
              font: { size: 12 },
              color: '#64748b'
            }
          }
        },
        plugins: {
          legend: { display: false }
        }
      }
    });
  } catch (e) {
    console.error('Ошибка при построении графика:', e);
  }
};


      useEffect(() => {
  // Вызываем построение графика при:
  // - изменении активной вкладки
  // - изменении диапазона дат
  if (activeTab === 'stats') {
    buildChart();
  }

  // Очистка при размонтировании
  return () => {
    if (chartInstanceRef.current) {
      chartInstanceRef.current.destroy();
      chartInstanceRef.current = null;
    }
  };
}, [activeTab]);


      const openModal = (task = null) => {
        if (task) {
          setEditingTask(task);
          let materialsToEdit = [];
          if (task.materials && Array.isArray(task.materials)) {
            materialsToEdit = task.materials.map(m => ({
              material: m.material || '',
              count: m.count || '',
              materialInputMode: materials.includes(m.material) ? 'select' : 'manual'
            }));
          } else if (task.material) {
            materialsToEdit = [{
              material: task.material || '',
              count: task.count || '',
              materialInputMode: materials.includes(task.material) ? 'select' : 'manual'
            }];
          } else {
            materialsToEdit = [{ material: '', count: '', materialInputMode: 'select' }];
          }

          setFormData({
            date: formatDateToInput(task.date),
            section: task.section || '',
            description: task.description || '',
            material: task.material || '',
            count: task.count || '',
            start_time: task.start_time || '08:00',
            end_time: task.end_time || '17:00',
            payment: task.payment || '',
            materials: materialsToEdit,
            all_count: task.all_count || '',
            newMaterial: '',
            newSection: ''
          });
        } else {
          const today = new Date();
          const year = today.getFullYear();
          const month = String(today.getMonth() + 1).padStart(2, '0');
          const day = String(today.getDate()).padStart(2, '0');
          const TodayData = `${year}-${month}-${day}`;
          setEditingTask(null);
          setFormData({
            date: TodayData,
            section: '',
            description: '',
            material: '',
            count: '',
            start_time: '08:00',
            end_time: '17:00',
            payment: '',
            materials: [{ material: '', count: '', materialInputMode: 'select' }],
            all_count: '',
            newMaterial: '',
            newSection: ''
          });
        }
        setShowModal(true);
      };

      const closeModal = () => {
        // console.log('Закрытие модального окна...');
        setShowModal(false);
        setEditingTask(null);
      };

      const handleInputChange = (e) => {
        const { name, value } = e.target;
        setFormData({ ...formData, [name]: value });
      };

      const handleMaterialChange = (index, e) => {
        const { name, value } = e.target;
        const newMaterials = [...formData.materials];
        newMaterials[index][name] = value;
        setFormData({ ...formData, materials: newMaterials });
      };

      const handleMaterialModeChange = (index, mode) => {
        const newMaterials = [...formData.materials];
        newMaterials[index].materialInputMode = mode;
        if (mode === 'manual') {
          newMaterials[index].material = '';
        }
        setFormData({ ...formData, materials: newMaterials });
      };

      const addMaterial = () => {
        setFormData({ ...formData, materials: [...formData.materials, { material: '', count: '', materialInputMode: 'select' }] });
      };

      const removeMaterial = (index) => {
        const newMaterials = formData.materials.filter((_, i) => i !== index);
        setFormData({ ...formData, materials: newMaterials });
      };

      const textContains = (els, text) => {
        return els.some((e) => text.includes(e));
      };

      const handleSubmit = (e) => {
  e.preventDefault();
  try {
    const start = new Date(`1970-01-01 ${formData.start_time}:00`);
    const end = new Date(`1970-01-01 ${formData.end_time}:00`);
    let workHours = (end - start) / (1000 * 60 * 60) - 1;
    if (workHours < 0) workHours += 24;
    if (isNaN(workHours)) workHours = 0;

    formData.materials.map((mat, i) => {
        if (textContains(['*', '-', '+', '/'], String(mat.count))) {
            formData.materials[i].count = round(calculate(mat.count), 2)
            // console.log(mat.count, round(calculate(mat.count), 2))
            // return formData.materials[i];
        }
    })

    const formattedDate = formatDateToDisplay(formData.date);
    const totalMaterialCount = formData.materials.reduce((sum, m) => sum + (Number(m.count) || 0), 0);

    // Автоматический расчет оплаты если не указана
    let payment = formData.payment;

    if (!payment && formData.materials.length > 0 && formData.section) {
      let canCalculate = true;
      payment = formData.materials.reduce((sum, m) => {
        const sectionPrices = materialPrices[formData.section] || {};
        const materialPrice = sectionPrices[m.material] || 0;
        if (!materialPrice) canCalculate = false;
        return sum + (Number(m.count) || 0) * materialPrice;
      }, 0);
      
      if (!canCalculate) payment = ''; // Не все цены известны
      localStorage.setItem('materialPrices', JSON.stringify(materialPrices));
    }

    const finalPayment = typeof formData.payment === 'number' 
    ? formData.payment
    : round(calculate(payment), 2) || 0;

    const newTask = { 
      ...formData, 
      date: formattedDate, 
      id: editingTask ? editingTask.id : Date.now(), 
      work_time: workHours,
      materials: formData.materials.map(m => ({
        material: m.material,
        count: m.count
      })),
      all_count: totalMaterialCount || '',
      payment: finalPayment || '' // Используем рассчитанное значение или оставляем пустым
    };

    if (editingTask) {
      setTasks(tasks.map(t => t.id === editingTask.id ? newTask : t));
    } else {
      setTasks([...tasks, newTask]);
    }
    closeModal();
  } catch (submitError) {
    console.error('Ошибка при сохранении задачи:', submitError);
  }
};

      const deleteTask = (id) => {
        // console.log('Удаление задачи с id:', id);
        setTasks(tasks.filter(t => t.id !== id));
      };

useEffect(() => {
  localStorage.setItem('tasks', JSON.stringify(tasks));
  localStorage.setItem('sections', JSON.stringify(sections));
  localStorage.setItem('materials', JSON.stringify(materials));
  localStorage.setItem('sortOrder', sortOrder);
  localStorage.setItem('presets', JSON.stringify(presets));
  localStorage.setItem('accentColor', accentColor);
}, [tasks, sections, materials, sortOrder, presets, accentColor]);

useEffect(() => {
  localStorage.setItem('materialPrices', JSON.stringify(materialPrices));
}, [materialPrices]);


      const handleExport = () => {
  try {
    const exportData = {
      tasks: tasks,
      sections: sections,
      materials: materials,
      materialPrices: materialPrices,
      presets: presets,
      accentColor: accentColor
    };
    
    const jsonString = JSON.stringify(exportData, null, 2);
    
    // Создаем имя файла с текущей датой
    const now = new Date();
    const dateStr = now.toISOString().slice(0, 10).replace(/-/g, '_'); // Формат YYYYMMDD
    const timeStr = now.toTimeString().slice(0, 8).replace(/:/g, '_'); // Формат HHMMSS
    const fileName = `N${dateStr}__${timeStr}.json`;
    
    // Создаем blob и ссылку для скачивания
    const blob = new Blob([jsonString], { type: 'application/json' });
    const url = URL.createObjectURL(blob);
    const link = document.createElement('a');
    link.href = url;
    link.download = fileName;
    document.body.appendChild(link);
    link.click();
    document.body.removeChild(link);
    URL.revokeObjectURL(url);
  } catch (e) {
    console.error('Ошибка при экспорте данных:', e);
  }
};

const handleImport = () => {
  const input = document.createElement('input');
  input.type = 'file';
  input.accept = '.json';
  
  input.onchange = e => {
    const file = e.target.files[0];
    if (!file) return;
    
    const reader = new FileReader();
    reader.onload = event => {
      try {
        const importedData = JSON.parse(event.target.result);
        
        // Проверяем наличие необходимых полей
        if (!importedData.tasks || !Array.isArray(importedData.tasks)) {
          throw new Error('Файл должен содержать массив задач');
        }
        
        // Обновляем все данные с заменой
        setTasks(importedData.tasks);
        setSections(importedData.sections || []);
        setMaterials(importedData.materials || []);
        setMaterialPrices(importedData.materialPrices || {});
        setPresets(importedData.presets || {});
        setAccentColor(importedData.accentColor || '#a16ff7')

        localStorage.setItem('tasks', JSON.stringify(importedData.tasks));
        localStorage.setItem('sections', JSON.stringify(importedData.sections));
        localStorage.setItem('materials', JSON.stringify(importedData.materials));
        localStorage.setItem('materialPrices', JSON.stringify(importedData.materialPrices));
        localStorage.setItem('presets', JSON.stringify(importedData.presets));
        localStorage.setItem('accentColor', accentColor);
        
        console.log('Импорт успешен');
      } catch (e) {
        console.error('Ошибка при импорте файла:', e.message);
        alert(`Ошибка: ${e.message}`);
      }
    };
    reader.readAsText(file);
  };
  
  input.click();
};
      
      const addSection = (newSection) => {
        if (newSection && !sections.includes(newSection)) {
          setSections([...sections, newSection]);
        }
      };

      const removeSection = (sectionToRemove) => {
        setSections(sections.filter(s => s !== sectionToRemove));
        setTasks(tasks.map(task => task.section === sectionToRemove ? { ...task, section: '' } : task));
      };

      const addMaterialSetting = (newMaterial) => {
        if (newMaterial && !materials.includes(newMaterial)) {
          setMaterials([...materials, newMaterial]);
        }
      };

      const removeMaterialSetting = (materialToRemove) => {
        setMaterials(materials.filter(m => m !== materialToRemove));
        setTasks(tasks.map(task => {
          if (task.material === materialToRemove) return { ...task, material: '' };
          if (task.materials) {
            return { ...task, materials: task.materials.map(m => m.material === materialToRemove ? { ...m, material: '' } : m) };
          }
          return task;
        }));
      };

      const sortTasksByDate = (tasksToSort) => {
        return [...tasksToSort].sort((a, b) => {
          const dateA = new Date(formatDateToInput(a.date));
          const dateB = new Date(formatDateToInput(b.date));
          return sortOrder === 'ascending' ? dateA - dateB : dateB - dateA;
        });
      };


const [filters, setFilters] = useState({
  section: '',
  material: '',
  minPayment: '',
  maxPayment: '',
  startDate: '',
  endDate: ''
});

// 2. Модифицируем функцию фильтрации
const filterTasks = (tasksToFilter) => {
  return tasksToFilter.filter(task => {
    // Фильтр по участку
    if (filters.section === 'Все участки') {
        
    } else if (filters.section && task.section !== filters.section) return false;
    
    // Фильтр по материалу
    if (filters.material) {
      if (filters.material !== 'Все материалы') {
          const hasMaterial = (task.materials?.some(m => m.material === filters.material) || (
                             task.material === filters.material || (
                               task.materials?.some(m => m.material.includes(filters.material))
                             ))
                             );

          if (!hasMaterial) return false;
      }
    }
    
    // Фильтр по оплате
    const payment = Number(task.payment) || 0;
    if (filters.minPayment && payment < Number(filters.minPayment)) return false;
    if (filters.maxPayment && payment > Number(filters.maxPayment)) return false;
    
    // Фильтр по дате
    if (filters.startDate || filters.endDate) {
      const taskDate = new Date(formatDateToInput(task.date));
      const startDate = filters.startDate ? new Date(filters.startDate) : null;
      const endDate = filters.endDate ? new Date(filters.endDate) : null;
      
      if (startDate && taskDate < startDate) return false;
      if (endDate && taskDate > endDate) return false;
    }
    
    return true;
  });
};


      const filteredAndSortedTasks = filterTasks(sortTasksByDate(tasks));
      
      const toggleSortOrder = () => {
        const newSortOrder = sortOrder === 'ascending' ? 'descending' : 'ascending';
        setSortOrder(newSortOrder);
      };

      const resetFilters = () => {
        setMaterialFilter('');
        setSortOrder('ascending');
      };

const [dateRange, setDateRange] = useState(() => {
  const now = new Date();
  const currentYear = now.getFullYear();
  const currentMonth = now.getMonth();
  
  // Если текущая дата меньше 25, берем предыдущий месяц
  const startDate = now.getDate() < 25 ? 
    new Date(currentYear, currentMonth - 1, 27) : 
    new Date(currentYear, currentMonth, 27);
  
  // Если текущая дата меньше 25, берем текущий месяц 25
  const endDate = now.getDate() < 25 ? 
    new Date(currentYear, currentMonth, 25) : 
    new Date(currentYear, currentMonth + 1, 25);
  
  return {
    start: startDate.toISOString().split('T')[0],
    end: endDate.toISOString().split('T')[0]
  };
});

const handleDateRangeChange = (e) => {
  const { name, value } = e.target;
  setDateRange(prev => {
    const newRange = { ...prev, [name]: value };
    // Вызываем buildChart после обновления состояния
    setTimeout(() => {
       buildChart();
    }, 50);
    return newRange;
  });
}

     
      const filteredTasks = tasks.filter(task => {
          if (!task.date) return false;
          const taskDateStr = formatDateToInput(task.date);
          if (!taskDateStr) return false;
          const taskDate = new Date(taskDateStr);
          const start = new Date(dateRange.start);
          const end = new Date(dateRange.end);
          return taskDate >= start && taskDate <= end;
      });

      const calculate = (value) => {
  try {
    // Удаляем все кроме цифр, операторов и скобок
    const sanitized = value.replace(/[^0-9+\-*/().]/g, '');
    
    // Запрещаем последовательные операторы
    if (/[+\-*/]{2,}/.test(sanitized)) return value;
    
    // Ограничиваем длину выражения
    if (sanitized.length > 30) return value;
    
    // Вычисляем только если последний символ - цифра или скобка
    if (/[\d)]$/.test(sanitized)) {
      // Используем Function вместо eval для безопасности
      return new Function(`return ${sanitized}`)();
    }
    return value;
  } catch {
    return value;
  }
};

      const totalTasks = tasks.length;
      const startDate = new Date('2025-04-25');
      const endDate = new Date('2025-05-25');
      const NoPayment = tasks
  .filter(task => task.payment == null || task.payment == 0)
  .map(task => {
      return {
        date: task.date
      };
  })

      const totalTask = tasks
  .filter(task => task.date && task.payment)
  .map(task => {
    try {
      const dateStr = formatDateToInput(task.date);
      if (!dateStr) return null;
      const taskDate = new Date(dateStr);
      if (isNaN(taskDate.getTime())) return null;
      return {
        date: task.date,
        payment: Number(task.payment) || 0,
        taskDate: taskDate
      };
    } catch (e) {
      console.error(`Ошибка при парсинге даты в задаче ${task.date}:`, e);
      return null;
    }
  })
  .filter(item => {
    if (!item) return false;
    const taskDate = item.taskDate;
    const startDate = new Date(dateRange.start);
    const endDate = new Date(dateRange.end);
    return taskDate >= startDate && taskDate <= endDate;
  })

  const totalTaskCount = totalTask.length;
  const totalPayment = totalTask.reduce((sum, item) => sum + item.payment, 0);


  const [materialPrices, setMaterialPrices] = useState(() => {
  try {
    const savedPrices = localStorage.getItem('materialPrices');
    return savedPrices ? JSON.parse(savedPrices) : {};
  } catch (e) {
    console.error('Ошибка при загрузке цен материалов:', e);
    return {};
  }
});

const pieChartRef = useRef(null);
  const pieChartInstanceRef = useRef(null);

  // Функция для построения круговой диаграммы
  const buildPieChart = () => {
    if (!pieChartRef.current || activeTab !== 'stats') return;
    
    try {
      // Уничтожаем предыдущий график
      if (pieChartInstanceRef.current) {
        pieChartInstanceRef.current.destroy();
      }

      // Группируем задачи по участкам
      const sectionCounts = {};
      filteredTasks.forEach(task => {
        const section = task.section || 'Без участка';
        sectionCounts[section] = (sectionCounts[section] || 0) + 1;
      });

      const sections = Object.keys(sectionCounts);
      const counts = Object.values(sectionCounts);

      if (sections.length === 0) {
        const ctx = pieChartRef.current.getContext('2d');
        ctx.font = '14px Inter';
        ctx.fillStyle = '#64748b';
        ctx.textAlign = 'center';
        ctx.fillText('Нет данных', pieChartRef.current.width / 2, pieChartRef.current.height / 2);
        return;
      }

      // Цвета для диаграммы
      const backgroundColors = [
        '#a16ff7', '#4c51bf', '#38b2ac', '#ed64a6', 
        '#ecc94b', '#f56565', '#4299e1', '#48bb78', '#9f7aea'
      ];

      const ctx = pieChartRef.current.getContext('2d');
      pieChartInstanceRef.current = new Chart(ctx, {
        type: 'doughnut',
        data: {
          labels: sections,
          datasets: [{
            data: counts,
            backgroundColor: backgroundColors,
            borderColor: '#ffffff',
            borderWidth: 2
          }]
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          plugins: {
            legend: {
              position: 'top',
              labels: {
                font: {
                  size: 12
                }
              }
            },
            tooltip: {
              callbacks: {
                label: function(context) {
                  const value = context.raw || 0;
                  const total = context.chart.data.datasets[0].data.reduce((a, b) => a + b, 0);
                  const percentage = Math.round((value / total) * 100);
                  const smen = value == 1 ? 'смена': (
                    value > 1 && value <= 4 ? 'смены' : 'смен'
                  );
                  return `${value} ${smen} (${percentage}%)`;
                }
              }
            }
          }
        }
      });
    } catch (e) {
      console.error('Ошибка при построении круговой диаграммы:', e);
    }
  };

  // Обновим useEffect для перерисовки обеих диаграмм
  useEffect(() => {
    if (activeTab === 'stats') {
      buildChart();
      buildPieChart();
    }

    return () => {
      if (chartInstanceRef.current) {
        chartInstanceRef.current.destroy();
        chartInstanceRef.current = null;
      }
      if (pieChartInstanceRef.current) {
        pieChartInstanceRef.current.destroy();
        pieChartInstanceRef.current = null;
      }
    };
  }, [activeTab, dateRange]);

const materialStats = tasks
  .filter(task => {
    if (!task.date) return false;
    const taskDateStr = formatDateToInput(task.date);
    if (!taskDateStr) return false;
    const taskDate = new Date(taskDateStr);
    const start = new Date(dateRange.start);
    const end = new Date(dateRange.end);
    return taskDate >= start && taskDate <= end;
  })
  .reduce((acc, task) => {
        try {
          if (task.materials && Array.isArray(task.materials)) {
            task.materials.forEach(mat => {
              const materialName = mat.material;
              const count = Number(mat.count) || 0;
              if (materialName) {
                acc[materialName] = (acc[materialName] || 0) + count;
              }
            });
          } else if (task.material && task.count) {
            const materialName = task.material;
            const count = Number(task.count) || 0;
            if (materialName) {
              acc[materialName] = (acc[materialName] || 0) + count;
            }
          }
          return acc;
        } catch (e) {
          console.error('Ошибка при обработке материалов в задаче:', task, e);
          return acc;
        }
    }, {});

      const materialStatsArray = Object.entries(materialStats).map(([material, count]) => {
          // Находим цену материала по участкам
          let price = 0;
          for (const section in materialPrices) {
            if (materialPrices[section][material]) {
              price = materialPrices[section][material];
              break;
            }
          }
          return {
            material,
            count,
            totalValue: count * price,
            price
          };
        }).filter(item => item.count > 0);


      const getBaseMaterialName = (fullName) => {
  return fullName ? fullName.split(' ')[0] : 'Без названия';
};

// 2. Расчет статистики по базовым названиям
const baseMaterialStats = tasks
  .filter(task => {
    if (!task.date) return false;
    const taskDateStr = formatDateToInput(task.date);
    if (!taskDateStr) return false;
    const taskDate = new Date(taskDateStr);
    const start = new Date(dateRange.start);
    const end = new Date(dateRange.end);
    return taskDate >= start && taskDate <= end;
  })
  .reduce((acc, task) => {
    const processMaterials = (materials) => {
      materials.forEach(mat => {
        if (mat.material) {
          const baseName = getBaseMaterialName(mat.material);
          const count = Number(mat.count) || 0;
          acc[baseName] = (acc[baseName] || 0) + count;
        }
      });
    };

    if (task.materials && Array.isArray(task.materials)) {
      processMaterials(task.materials);
    } else if (task.material) {
      processMaterials([{material: task.material, count: task.count}]);
    }
    return acc;
  }, {});

const SelectChose = ({
  placeholder_text,
  List,
  value,
  onChange,
  onSet = () => {}
}) => {
    const [show, setshow] = useState(false);

    return (
    <div className="relative">
      <div className="flex flex-col">
        <input
          type="text"
          readOnly={true}
          value={value || ''}
          onChange={onChange}
          onFocus={() => setshow(true)}
          onBlur={() => {
            const int_ = setTimeout(() => {
               setshow(false)
            }, 50)
            return () => clearInterval(int_)
          }}
          className="form-input rounded-md"
          placeholder={placeholder_text}
        />
        {show && List.length > 0 && (
        <div className="absolute mt-12 z-10 w-full bg-white border border-gray-300 rounded-md shadow-lg mt-1 max-h-60 overflow-y-auto">
          {List.map((element, index) => (
            <div
              key={index}
              className="px-4 py-2 hover:bg-purple-100 cursor-pointer border-b border-gray-100 last:border-b-0"
              onClick={() => {
                onSet(element);
                setshow(false);
              }}
            >
              <p>{element}</p>
            </div>
          ))}
        </div>
        )}
      </div>
    </div>
    );
}

const DropCategory = ({
   title,
   items,
   onDelete,
   shown,
   setshown
}) => {
  const [isOpen, setIsOpen] = useState(false);
  const dropdownRef = useRef(null);

  // Закрытие списка при клике вне компонента
  useEffect(() => {
    const handleClickOutside = (event) => {
      if (dropdownRef.current && !dropdownRef.current.contains(event.target)) {
        setIsOpen(false);
      }
    };

    document.addEventListener('mousedown', handleClickOutside);
    return () => document.removeEventListener('mousedown', handleClickOutside);
  }, []);

  const toggleDropdown = () => setIsOpen(!isOpen)

  const itemsRender = () => {
    return items.map((item) => {
      if (!item.includes(title)) return null;
      
      return (
        <li key={item} className="dropdown-item">
          <span>{item}</span>
          <DeleteButton
            classes="material-remove-button"
            onDelete={() => onDelete(item)}
          />
        </li>
      );
    });
  }

  return (
    <div className="dropdown" ref={dropdownRef}>
      <button 
        className="form-input rounded-md mb-2 flex items-center justify-between"
        onClick={toggleDropdown}
        aria-expanded={isOpen}
      >
        <div>{title}</div>
        <i className={`mr-1 fas fa-chevron-${isOpen ? 'down' : 'right'}`}></i>
      </button>
      
      {isOpen && (
        <ul className="dropdown-menu rounded-md">
           {itemsRender()}
        </ul>
      )}
    </div>
  );
};

const [presets, setPresets] = useState(() => {
  try {
    const savedPresets = localStorage.getItem('presets');
    return savedPresets ? JSON.parse(savedPresets) : [];
  } catch (e) {
    console.error('Ошибка при загрузке пресетов:', e);
    return [];
  }
});

const [presetForm, setPresetForm] = useState({
  section: '',
  description: '',
  materials: [{material: '', count: ''}],
  start_time: '08:00',
  end_time: '17:00',
  payment: ''
});

useEffect(() => {
  localStorage.setItem('presets', JSON.stringify(presets));
}, [presets]);

useEffect(() => {
  if (showModal && formData.section && editingTask == null) {
    const preset = presets.find(p => p.section === formData.section);
    if (preset) {
      setFormData(prev => ({
        ...prev,
        description: preset.description || prev.description,
        materials: preset.materials?.length > 0 
          ? [...preset.materials] 
          : prev.materials,
        start_time: preset.start_time || prev.start_time,
        end_time: preset.end_time || prev.end_time,
        payment: preset.payment || prev.payment
      }));
    }
  }
}, [formData.section, showModal, presets]);

useEffect(() => {
    window.scrollTo({
        top: 760
    });
}, [])

const baseMaterialStatsArray = Object.entries(baseMaterialStats)
  .map(([material, count]) => ({ material, count }))
  .filter(item => item.count > 0)
  .sort((a, b) => b.count - a.count);


      return (
        <div>
          {activeTab === 'tasks' ? (
            <>
              <h1 className="mb-6">Управление Сменами</h1>
              <div className="filter-container">
  <div className="filter-row">
    {/* Фильтр по участку */}
    <div className="flex-1 min-w-[200px]">
      <label className="form-label">Участок</label>
      <SelectChose
          placeholder_text="Участок"
          List={['Все участки', ...sections]}
          value={filters.section}
          onChange={(e) => setFilters({...filters, section: e.target.value})}
          onSet={(v) => setFilters({...filters, section: v})}
      />
    </div>
    
    {/* Новый фильтр по материалу */}
    <div className="flex-1 min-w-[200px]">
      <label className="form-label">Материал</label>
      <SelectChose
          placeholder_text="Материал"
          List={['Все материалы', ...materials]}
          value={filters.material}
          onChange={(e) => setFilters({...filters, material: e.target.value})}
          onSet={(v) => setFilters({...filters, material: v})}
      />
    </div>
  </div>
  
  <div className="filter-row mt-4">
    {/* Фильтр по оплате */}
    <div className="flex-1 min-w-[200px]">
      <label className="form-label">Оплата от</label>
      <input
        type="number"
        value={filters.minPayment}
        onChange={(e) => setFilters({...filters, minPayment: e.target.value})}
        className="form-input"
        placeholder="Минимум"
      />
    </div>
    
    <div className="flex-1 min-w-[200px]">
      <label className="form-label">Оплата до</label>
      <input
        type="number"
        value={filters.maxPayment}
        onChange={(e) => setFilters({...filters, maxPayment: e.target.value})}
        className="form-input"
        placeholder="Максимум"
      />
    </div>
  </div>
  
  <div className="filter-row mt-4">
    {/* Фильтр по дате */}
    <div className="flex-1 min-w-[200px]">
      <label className="form-label">Дата с</label>
      <input
        type="date"
        value={filters.startDate}
        onChange={(e) => setFilters({...filters, startDate: e.target.value})}
        className="form-input"
      />
    </div>
    
    <div className="flex-1 min-w-[200px]">
      <label className="form-label">Дата по</label>
      <input
        type="date"
        value={filters.endDate}
        onChange={(e) => setFilters({...filters, endDate: e.target.value})}
        className="form-input"
      />
    </div>
 
    <button onClick={toggleSortOrder} className="sort-button">
        {sortOrder === 'ascending' ? 'По убыванию дат' : 'По возрастанию дат'}
    </button>


    {/* Кнопка сброса */}
    <button 
      onClick={() => setFilters({
        section: '',
        material: '',
        minPayment: '',
        maxPayment: '',
        startDate: '',
        endDate: ''
      })}
      className="reset-button"
    >
      Сбросить все
    </button>

<div className="flex items-center gap-2 mt-4 p-2 bg-[var(--accent-10)] rounded-lg">
    <svg xmlns="http://www.w3.org/2000/svg" className="h-5 w-5 text-[var(--accent-color)]" fill="none" viewBox="0 0 24 24" stroke="currentColor">
      <path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M9 5H7a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2" />
    </svg>
    <span className="text-sm font-medium text-gray-700">
      Всего смен: <span className="font-bold text-[var(--accent-color)]">{filteredAndSortedTasks.length}</span>
    </span>
  </div>

  </div>
</div>
              <div className="tasks-container">
                {filteredAndSortedTasks.length === 0 ? (
                  <p className="p-4 text-gray-500">Нет задач для отображения.</p>
                ) : (
                  filteredAndSortedTasks.map((task) => {
                    const totalMaterialCount = task.all_count || (task.materials && Array.isArray(task.materials) 
                      ? task.materials.reduce((sum, m) => sum + (Number(m.count) || 0), 0) 
                      : task.count || 0);
                    return (
                      <div key={task.id} className="task-card">
                        <div className="task-field">
                          <span className="task-field-label">Дата:</span>
                          <span className="task-field-value">{task.date || 'Не указана'}</span>
                        </div>
                        <div className="task-field">
                          <span className="task-field-label">Участок:</span>
                          <span className="task-field-value">{task.section || 'Не указан'}</span>
                        </div>
                        <div className="task-field description">
                          <span className="task-field-label">Описание:</span>
                          <span className="task-field-value description">{task.description || 'Не указано'}</span>
                        </div>
                        <div className="task-field materials_">
                          <span className="task-field-label">Материалы:</span>
                          {task.materials.length == 0 ? (
                             <span className="task-field-value flex justify-center">Не указано</span>
                          ) : (
                          <ul className=" material-list task-field-value">
                            {task.materials && Array.isArray(task.materials) ? (
                              task.materials.map((mat, index) => (
                                <li key={index} className="material-item">
                                  <svg xmlns="http://www.w3.org/2000/svg" fill="currentColor" viewBox="0 0 256 222" stroke="currentColor" strokeWidth="2">
                                    <path strokeLinecap="round" strokeLinejoin="round" d="M215.771 151.107a7.111 7.111 0 0 0 3.57-6.144l.128-41.153a7.111 7.111 0 0 1 3.57-6.145l22.308-12.814A7.111 7.111 0 0 1 256 91.016v74.818a7.11 7.11 0 0 1-3.57 6.166l-84.19 48.357a7.111 7.111 0 0 1-7.07.007l-66.07-37.79a7.111 7.111 0 0 1-3.585-6.172v-37.726c0-.042.05-.07.093-.05c.035.022.085 0 .085-.05v-.042c0-.028.014-.057.043-.071l54.416-31.261c.05-.029.028-.107-.029-.107a.057.057 0 0 1-.057-.057l.107-36.986a7.111 7.111 0 0 0-10.667-6.187L95.064 87.17a7.111 7.111 0 0 1-7.097 0l-40.57-23.36a7.111 7.111 0 0 0-10.66 6.158v66.846a7.111 7.111 0 0 1-10.638 6.18L3.584 130.12A7.111 7.111 0 0 1 0 123.935L.2 7.095A7.111 7.111 0 0 1 10.851.946L87.974 45.24a7.111 7.111 0 0 0 7.083 0l77.1-44.296a7.111 7.111 0 0 1 10.653 6.172v116.867a7.111 7.111 0 0 1-3.562 6.166l-40.378 23.254a7.111 7.111 0 0 0 .028 12.338l22.273 12.68a7.111 7.111 0 0 0 7.061-.015l47.54-27.3Zm4.672-104.835a7.111 7.111 0 0 0 10.767 6.094l21.334-12.8A7.111 7.111 0 0 0 256 33.472V7.387A7.111 7.111 0 0 0 245.233 1.3L223.9 14.1a7.111 7.111 0 0 0-3.457 6.095v26.084v-.007Z"/>
                                  </svg>
                                  <div className="material-text">
                                    <span className="material-name">{mat.material || 'Не указан'}</span>
                                    <span className="material-count">
                                      {mat.count || 0}
                                      {materialPrices[task.section] && materialPrices[task.section][mat.material] ? ` × ${materialPrices[task.section][mat.material]} руб.` : ''}
                                    </span>
                                  </div>
                                </li>
                              ))
                            ) : task.material ? (
                              <li className="material-item">
                                <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor" strokeWidth="2">
                                  <path strokeLinecap="round" strokeLinejoin="round" d="M19 14l-7 7m0 0l-7-7m7 7V3" />
                                </svg>
                                <div className="material-text">
                                    <span className="material-name">{mat.material || 'Не указан'}</span>
                                    <span className="material-count">
                                      {mat.count || 0}
                                    </span>
                                </div>
                              </li>
                            ) : (
                              <li className="material-item">
                                <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor" strokeWidth="2">
                                  <path strokeLinecap="round" strokeLinejoin="round" d="M19 14l-7 7m0 0l-7-7m7 7V3" />
                                </svg>
                                <div className="material-text">
                                    <span className="material-name">{mat.material || 'Не указан'}</span>
                                    <span className="material-count">
                                      {mat.count || 0}
                                    </span>
                                </div>
                              </li>
                            )}
                          </ul>
                          )}
                        </div>
                        <div className="task-field">
                          <span className="task-field-label">Общее количество:</span>
                          <span className="task-field-value">
                            {totalMaterialCount > 0 ? totalMaterialCount : 0}
                          </span>
                        </div>
                        <div className="task-field">
                          <span className="task-field-label">Время:</span>
                          <span className="task-field-value">
                            {`с ${task.start_time || '08:00'} до ${task.end_time || '17:00'} (${Math.round(task.work_time || ((new Date(`1970-01-01 ${task.end_time || '17:00'}:00`) - new Date(`1970-01-01 ${task.start_time || '09:00'}:00`)) / (1000 * 60 * 60) - 1))})`}
                          </span>
                        </div>
                        <div className="task-field">
                          <span className="task-field-label">Оплата:</span>
                          <span className="task-field-value">{task.payment || 'Не указана'}</span>
                        </div>
                        <div className="action-buttons">
                          <button 
                            onClick={() => openModal(task)} 
                            className="edit-button action-button"
                          >
                            Редактировать
                          </button>
                          <DeleteButton 
                            onDelete={() => deleteTask(task.id)}
                            classes="delete-button action-button"
                          />
                        </div>
                      </div>
                    );
                  })
                )}
              </div>
              <button onClick={() => openModal()} className="add-button mb-16">
                <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor" strokeWidth="2" className="w-6 h-6">
                  <path strokeLinecap="round" strokeLinejoin="round" d="M12 4v16m8-8H4" />
                </svg>
              </button>
              <button onClick={scrollToTop} className="add-button">
  <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor" strokeWidth="2" className="w-6 h-6">
    <path strokeLinecap="round" strokeLinejoin="round" d="M5 10l7-7m0 0l7 7m-7-7v18" />
  </svg>
</button>
            </>
          ) : activeTab === 'stats' ? (
            <>
              <h1 className="mb-6">Статистика</h1>
              <div className="stats-container">
                <p className="text-lg font-semibold">Общая информация</p>
                <div className="grid grid-cols-1 md:grid-cols-2 gap-4 mt-4 mb-4">
                  <div className="p-4 bg-[var(--accent-10)] rounded-lg">
                    <p className="text-sm text-gray-600">Всего смен</p>
                    <p className="text-xl font-bold text-[var(--accent-color)]">{totalTasks}</p>
                  </div>
                  <div className="p-4 bg-red-50 rounded-lg">
                    <p className="text-sm text-gray-600">Смен без оплаты</p>
                    <p className="text-xl font-bold text-red-700">{NoPayment.length}</p>
                    <ul className="mt-2 flex w-full pt-2 justify-between flex-wrap items-center">
                    {NoPayment.map((p) => (
                        <li
                          key={p.date}
                          className="nopay-item text-sm justify-center flex-grow ml-2"
                        >{p.date}</li>
                    ))}
                    </ul>
                  </div>

                  <div className="p-4 bg-green-50 rounded-lg">
                    <p className="text-sm text-gray-600">Общая оплата за {totalTaskCount} смен</p>
                    <p className="text-xl font-bold text-green-700">{totalPayment.toLocaleString()}</p>
                  </div>
                </div>
                <div className="filter-container mb-4">
                  <div className="filter-row">
                  <div className="flex-1 min-w-[150px]">
                    <label className="form-label">Дата начала</label>
                    <input
                      type="date"
                      name="start"
                      value={dateRange.start}
                      onChange={handleDateRangeChange}
                      className="form-input"
                    />
                  </div>
                  <div className="flex-1 min-w-[150px]">
                    <label className="form-label">Дата окончания</label>
                    <input
                      type="date"
                      name="end"
                      value={dateRange.end}
                      onChange={handleDateRangeChange}
                      className="form-input"
                    />
                  </div>
                </div>
              </div>
              { materialStatsArray.length > 0 && (
              <table className="material-stats-table">
  <thead>
    <tr>
      <th>Материал</th>
      <th>Количество</th>
      <th>Цена за ед.</th>
      <th>Общая стоимость</th>
    </tr>
  </thead>
  <tbody>
    {materialStatsArray.map((stat, index) => (
      <tr key={index}>
        <td>{stat.material}</td>
        <td>{stat.count}</td>
        <td>{stat.price ? `${stat.price} руб.` : '—'}</td>
        <td>{stat.totalValue ? `${stat.totalValue.toLocaleString()} руб.` : '—'}</td>
      </tr>
    ))}
  </tbody>
</table>
)}

              <div className="mt-8">
                 { baseMaterialStatsArray.length > 0 && (
                 <>
                  <p className="text-lg font-semibold mb-4">Сводка по типам материалов</p>
                  <table className="material-stats-table">
                    <thead>
                      <tr>
                        <th>Тип материала</th>
                        <th>Общее количество</th>
                      </tr>
                    </thead>
                    <tbody>
                      {baseMaterialStatsArray.map((stat, index) => (
                        <tr key={`base-${index}`}>
                          <td>{stat.material}</td>
                          <td>{stat.count}</td>
                        </tr>
                      ))}
                    </tbody>
                  </table>
                  </>
                  )}
                </div>
                <div className="chart-container">
                  <canvas ref={chartRef} className="chart-canvas"></canvas>
                </div>
                <div className="pie-chart-container">
                  <canvas ref={pieChartRef}></canvas>
                </div>
              </div>
            </>
          ) : (
            <>
              <h1 className="mb-6">Настройки</h1>
              <div className="settings-container">
                <div className="settings-buttons">
  <button
    onClick={handleExport}
    className="submit-button w-full"
  >
    <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor" strokeWidth="2">
      <path strokeLinecap="round" strokeLinejoin="round" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-4l-4 4m0 0l-4-4m4 4V4" />
    </svg>
    Экспорт в файл
  </button>
  
  <button
    onClick={handleImport}
    className="submit-button w-full"
  >
    <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor" strokeWidth="2">
      <path strokeLinecap="round" strokeLinejoin="round" d="M7 16a4 4 0 01-.88-7.903A5 5 0 1115.9 6L16 6a5 5 0 011 9.9M15 13l-3-3m0 0l-3 3m3-3v12" />
    </svg>
    Импорт из файла
  </button>
</div>

<p className="text-lg font-semibold mt-6">Основной цвет</p>
<div className="flex items-center gap-4 mb-6">
  <input 
    type="color" 
    value={accentColor}
    onChange={(e) => setAccentColor(e.target.value)}
    className="w-12 h-12 cursor-pointer"
  />
  <input
    type="text"
    value={accentColor}
    onChange={(e) => setAccentColor(e.target.value)}
    className="form-input flex-1"
    placeholder="#a16ff7"
  />
  <button 
    onClick={() => setAccentColor('#a16ff7')}
    className="px-4 py-2 bg-gray-200 rounded-md"
  >
    Сбросить
  </button>
</div>



<p className="text-lg font-semibold mt-6">Управление материалами</p>
    <div className="mb-4">
      <label className="form-label">Добавить материал</label>
              <input
                type="text"
                value={formData.newMaterial}
                onChange={(e) => setFormData({ ...formData, newMaterial: e.target.value })}
                className="form-input"
                placeholder="Новый материал"
              />
              <button
                onClick={() => { addMaterialSetting(formData.newMaterial); setFormData({ ...formData, newMaterial: '' }); }}
                className="material-add-button mt-2"
              >
                Добавить материал
              </button>
            </div>
            {Object.entries(
  materials.reduce((groups, material) => {
    const category = material.split(' ')[0];
    groups[category] = groups[category] || [];
    groups[category].push(material);
    return groups;
  }, {})
).map(([category, items]) => {
  // Для категорий с одним материалом - простой элемент
  if (items.length === 1) {
    return items.map(material => (
      <div key={material} className="nopay-item flex justify-between items-center gap-2 mb-2">
        <span className="text-sm">{material}</span>
        <DeleteButton
          classes="material-remove-button"
          onDelete={() => removeMaterialSetting(material)}
        />
      </div>
    ));
  }
  
  // Для категорий с несколькими материалами - DropCategory
  return (
    <DropCategory
      key={category}
      title={category}
      items={items}
      onDelete={removeMaterialSetting}
    />
  );
})}

<p className="text-lg font-semibold mt-6">Цены материалов</p>
<div className="mb-4">
  <label className="form-label">Участок</label>
  <SelectChose
      placeholder_text="Участок"
      List={sections}
      value={formData.selectedSectionForPrice}
      onChange={(e) => setFormData({...formData, selectedSectionForPrice: e.target.value})}
      onSet={(v) => setFormData({...formData, selectedSectionForPrice: v})}
  />
  <label className="form-label mt-2">Материал</label>
  <SelectChose
      placeholder_text="Материал"
      List={materials}
      value={formData.selectedMaterialForPrice || ''}
      onChange={(e) => setFormData({...formData, selectedMaterialForPrice: e.target.value})}
      onSet={(v) => setFormData({...formData, selectedMaterialForPrice: v})}
  />
    <label className="form-label mt-2">Цена за единицу</label>
  <input
    type="number"
    value={formData.materialPriceValue || ''}
    onChange={(e) => setFormData({...formData, materialPriceValue: e.target.value})}
    className="form-input"
    placeholder="Введите цену"
  />
<button
  onClick={() => {
    if (formData.selectedSectionForPrice && formData.selectedMaterialForPrice && formData.materialPriceValue) {
      const newPrices = {
        ...materialPrices,
        [formData.selectedSectionForPrice]: {
          ...materialPrices[formData.selectedSectionForPrice],
          [formData.selectedMaterialForPrice]: Number(formData.materialPriceValue)
        }
      };
      setMaterialPrices(newPrices);
      
      // Сохраняем в localStorage сразу после обновления состояния
      localStorage.setItem('materialPrices', JSON.stringify(newPrices));
      
      setFormData({...formData, materialPriceValue: '', selectedMaterialForPrice: '', selectedSectionForPrice: ''});
    }
  }}
  className="material-add-button mt-2"
>
    Установить цену
  </button>
</div>

{Object.entries(materialPrices).map(([section, prices]) => (
  <div key={`section-${section}`} className="mb-4">
    {sections.includes(section) && (
      <h3 className="font-semibold text-gray-700 mb-2">{section}</h3>
    )}
    {Object.entries(prices || {}).map(([material, price]) => (
      <div key={`price-${section}-${material}`} className="flex nopay-item justify-between items-center gap-2 mb-2">
        <span className="text-sm">{material}: {price}/ед.</span>
<DeleteButton
  classes="material-remove-button"
  onDelete={() => {
    setMaterialPrices(prevPrices => {
      const newPrices = {...prevPrices};
      if (newPrices[section]) {
        delete newPrices[section][material];
        if (Object.keys(newPrices[section]).length === 0) {
          delete newPrices[section];
        }
      }
      
      // Сохраняем обновленные цены
      localStorage.setItem('materialPrices', JSON.stringify(newPrices));
      
      return newPrices;
    });
  }}
/>
      </div>
    ))}
  </div>
))}

<p className="text-lg font-semibold mt-6">Пресеты участков</p>
<div className="mb-4">
  <label className="form-label">Участок для пресета</label>
  <SelectChose
    placeholder_text="Выберите участок"
    List={sections}
    value={presetForm.section}
    onSet={(v) => setPresetForm({...presetForm, section: v})}
  />
  
  <label className="form-label mt-2">Описание</label>
  <input
    type="text"
    value={presetForm.description}
    onChange={(e) => setPresetForm({...presetForm, description: e.target.value})}
    className="form-input"
    placeholder="Описание (не обязательно)"
  />
  
  {presetForm.materials.map((mat, index) => (
    <div key={index} className="material-row mt-2">
      <div className="material-input">
        <label className="form-label">Материал</label>
        <SelectChose
          placeholder_text="Выберите материал"
          List={materials}
          value={mat.material}
          onSet={(v) => {
            const newMaterials = [...presetForm.materials];
            newMaterials[index].material = v;
            setPresetForm({...presetForm, materials: newMaterials});
          }}
        />
      </div>
      <div className="material-input">
        <label className="form-label">Количество</label>
        <input
          type="text"
          value={mat.count}
          onChange={(e) => {
            const newMaterials = [...presetForm.materials];
            newMaterials[index].count = e.target.value;
            setPresetForm({...presetForm, materials: newMaterials});
          }}
          placeholder="Количество"
          className="form-input"
        />
      </div>
      <button 
        onClick={() => {
          const newMaterials = presetForm.materials.filter((_, i) => i !== index);
          setPresetForm({...presetForm, materials: newMaterials});
        }}
        className="material-remove-button"
      >
        Удалить
      </button>
    </div>
  ))}
  
  <button 
    onClick={() => setPresetForm({
      ...presetForm, 
      materials: [...presetForm.materials, {material: '', count: ''}]
    })}
    className="material-add-button mt-2"
  >
    Добавить материал
  </button>
  
  <div className="grid grid-cols-2 gap-4 mt-4">
    <div>
      <label className="form-label">Начало смены</label>
      <input
        type="time"
        value={presetForm.start_time}
        onChange={(e) => setPresetForm({...presetForm, start_time: e.target.value})}
        className="form-input"
      />
    </div>
    <div>
      <label className="form-label">Конец смены</label>
      <input
        type="time"
        value={presetForm.end_time}
        onChange={(e) => setPresetForm({...presetForm, end_time: e.target.value})}
        className="form-input"
      />
    </div>
  </div>
  
  <label className="form-label mt-2">Оплата</label>
  <input
    type="text"
    value={presetForm.payment}
    onChange={(e) => setPresetForm({...presetForm, payment: e.target.value})}
    className="form-input"
    placeholder="Оплата"
  />
  
  <button
    onClick={() => {
      if (presetForm.section) {
        const existingIndex = presets.findIndex(p => p.section === presetForm.section);
        let newPresets;
        if (existingIndex >= 0) {
          newPresets = [...presets];
          newPresets[existingIndex] = {...presetForm};
        } else {
          newPresets = [...presets, {...presetForm}];
        }
        
        setPresets(newPresets);
        setPresetForm({
          section: '',
          description: '',
          materials: [{material: '', count: ''}],
          start_time: '08:00',
          end_time: '17:00',
          payment: ''
        });
      }
    }}
    className="material-add-button mt-2"
  >
    {presets.some((p) => p.section === presetForm.section) ? 'Обновить пресет' : 'Сохранить пресет'}
  </button>
</div>

<div className="mt-4">
  {presets.map((preset, index) => (
    <div key={index} className="nopay-item flex justify-between items-center gap-2 mb-2">
      <div>
        <p className="font-medium">{preset.section}</p>
        {preset.description && <p className="text-sm">{preset.description}</p>}
      </div>
      <DeleteButton
        classes="material-remove-button"
        onDelete={() => {
          const newPresets = [...presets];
          newPresets.splice(index, 1);
          setPresets(newPresets);
        }}
      />
    </div>
  ))}
</div>

                <p className="text-lg font-semibold mt-6">Управление участками</p>
                <div className="mb-4">
                  <label className="form-label">Добавить участок</label>
                  <input
                    type="text"
                    value={formData.newSection}
                    onChange={(e) => setFormData({ ...formData, newSection: e.target.value })}
                    className="form-input"
                    placeholder="Новый участок"
                  />
                  <button
                    onClick={() => { addSection(formData.newSection); setFormData({ ...formData, newSection: '' }); }}
                    className="material-add-button mt-2"
                  >
                    Добавить участок
                  </button>
                </div>
                {sections.map((section) => (
                  <div key={section} className="nopay-item flex justify-between items-center gap-2 mb-2">
                    <span className="text-sm">{section}</span>
                    <DeleteButton
                        classes="material-remove-button"
                        onDelete={() => {removeSection(section)}}
                    />
                  </div>
                ))}
              </div>
            </>
          )}
          {showModal && (
            <div className="modal">
              <div className="modal-content">
                <button onClick={closeModal} className="close-button">×</button>
                <h2 className="text-lg font-semibold mb-6">{editingTask ? 'Редактировать задачу' : 'Добавить задачу'}</h2>
                <div>
                  <div className="mb-4">
                    <label className="form-label">Дата</label>
                    <input
                      type="date"
                      name="date"
                      value={formData.date}
                      onChange={handleInputChange}
                      className="form-input"
                      required
                    />
                  </div>
                  <div className="mb-4">
                    <label className="form-label">Участок</label>
                    <SelectChose
                      placeholder_text="Участок"
                      List={sections}
                      value={formData.section}
                      onChange={handleInputChange}
                      onSet={(v) => setFormData({...formData, section: v})}
                    />
                  </div>
                  <div className="mb-4">
                    <label className="form-label">Описание</label>
                    <textarea
                      name="description"
                      value={formData.description}
                      onChange={handleInputChange}
                      placeholder="Описание задачи"
                      className="form-textarea"
                    />
                  </div>
                  {formData.materials.map((mat, index) => (
                    <div key={index} className="material-row">
                      <div className="material-input">
                        <label className="form-label">Материал</label>
                        <div className="material-mode-toggle">
                          <label>
                            <input
                              type="radio"
                              name={`material-mode-${index}`}
                              checked={mat.materialInputMode === 'select'}
                              onChange={() => handleMaterialModeChange(index, 'select')}
                            />
                            Выбрать из списка
                          </label>
                          <label>
                            <input
                              type="radio"
                              name={`material-mode-${index}`}
                              checked={mat.materialInputMode === 'manual'}
                              onChange={() => handleMaterialModeChange(index, 'manual')}
                            />
                            Ввести вручную
                          </label>
                        </div>
                        {mat.materialInputMode === 'select' ? (
                        <SelectChose
                          placeholder_text="Выберете Материал"
                          List={materials}
                          value={mat.material}
                          onSet={(v) => {
                              const newMaterials = [...formData.materials];
                              newMaterials[index].material = v;
                              setFormData({ ...formData, materials: newMaterials });
                          }}
                          />
                        ) : (
                          <input
                            type="text"
                            name="material"
                            value={mat.material}
                            onChange={(e) => handleMaterialChange(index, e)}
                            placeholder="Введите материал"
                            className="form-input"
                            required
                          />
                        )}
                      </div>
                      <div className="material-input">
                        <label className="form-label">Количество</label>
                        <input
                          type="text"
                          name="count"
                          value={mat.count}
                          onChange={(e) => handleMaterialChange(index, e)}
                          placeholder="Количество"
                          className="form-input"
                          required
                        />
                      </div>
                      <DeleteButton
                         classes="material-remove-button"
                         onDelete={() => removeMaterial(index)} 
                      />
                    </div>
                  ))}
                  <button type="button" onClick={addMaterial} className="material-add-button">
                    Добавить материал
                  </button>
                  <div className="mb-4">
                    <label className="form-label">Начало смены</label>
                    <input
                      type="time"
                      name="start_time"
                      value={formData.start_time}
                      onChange={handleInputChange}
                      className="form-input"
                      required
                    />
                  </div>
                  <div className="mb-4">
                    <label className="form-label">Конец смены</label>
                    <input
                      type="time"
                      name="end_time"
                      value={formData.end_time}
                      onChange={handleInputChange}
                      className="form-input"
                      required
                    />
                  </div>
                  <div className="mb-6">
                    <label className="form-label">Оплата (руб.)</label>
                    <input
                      type="text"
                      name="payment"
                      value={formData.payment}
                      onChange={handleInputChange}
                      placeholder="Оплата"
                      className="form-input"
                    />
                  </div>
                  <button onClick={handleSubmit} className="submit-button">
                    <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor" strokeWidth="2">
                      <path strokeLinecap="round" strokeLinejoin="round" d="M5 13l4 4L19 7" />
                    </svg>
                    {editingTask ? 'Сохранить' : 'Добавить'}
                  </button>
                </div>
              </div>
            </div>
          )}
          <div className="nav-bar">
            <a href="#" className={`nav-item ${activeTab === 'tasks' ? 'active' : ''}`} onClick={() => setActiveTab('tasks')}>
              <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor" strokeWidth="2">
                <path strokeLinecap="round" strokeLinejoin="round" d="M9 5H7a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012 2h2a2 2 0 012-2m-3 7h3m-3 4h3m-6-4h.01M9 16h.01" />
              </svg>
              Смены
            </a>
            <a href="#" className={`nav-item ${activeTab === 'stats' ? 'active' : ''}`} onClick={() => setActiveTab('stats')}>
              <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor" strokeWidth="2">
                <path strokeLinecap="round" strokeLinejoin="round" d="M9 19v-6a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2a2 2 0 002-2zm0 0V9a2 2 0 012-2h2a2 2 0 012 2v10m-6 0a2 2 0 002 2h2a2 2 0 002-2m0 0V5a2 2 0 012-2h2a2 2 0 012 2v14a2 2 0 01-2 2h-2a2 2 0 01-2-2z" />
              </svg>
              Статистика
            </a>
            <a href="#" className={`nav-item ${activeTab === 'settings' ? 'active' : ''}`} onClick={() => setActiveTab('settings')}>
              <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor" strokeWidth="2">
                <path strokeLinecap="round" strokeLinejoin="round" d="M10.325 4.317c.426-1.756 2.924-1.756 3.35 0a1.724 1.724 0 002.573 1.066c1.543-.94 3.31.826 2.37 2.37a1.724 1.724 0 001.065 2.572c1.756.426 1.756 2.924 0 3.35a1.724 1.724 0 00-1.066 2.573c.94 1.543-.826 3.31-2.37 2.37a1.724 1.724 0 00-2.572 1.065c-.426 1.756-2.924 1.756-3.35 0a1.724 1.724 0 00-2.573-1.066c-1.543.94-3.31-.826-2.37-2.37a1.724 1.724 0 00-1.065-2.572c-1.756-.426-1.756-2.924 0-3.35a1.724 1.724 0 001.066-2.573c-.94-1.543.826-3.31 2.37-2.37a1.724 1.724 0 002.572-1.065z" />
                <path strokeLinecap="round" strokeLinejoin="round" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z" />
              </svg>
              Настройки
            </a>
          </div>
        </div>
      );
    }

    const root = createRoot(document.getElementById('root'));
    root.render(<App />);
  </script>
</body>
</html>
